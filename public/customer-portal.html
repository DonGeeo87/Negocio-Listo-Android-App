<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Portal - NegocioListo</title>
    <link rel="icon" type="image/png" href="assets/icon_negociolisto.png">
    <!-- Versi칩n: 2025-11-07 16:04 - Portal del Cliente -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            /* Template por defecto - ser치 sobrescrito por los estilos de template espec칤ficos */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            transition: background 0.3s ease;
        }
        
        /* IMPORTANTE: Los estilos de template deben tener mayor especificidad */
        /* Asegurar que los templates sobrescriban los estilos base */

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
            color: white;
            padding: 40px 30px;
            border-radius: 16px 16px 0 0;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            background: white;
            border-radius: 0 0 16px 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #009FE3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        .debug-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            border: 2px solid #0f0;
        }

        .debug-console.active {
            display: block;
        }

        .debug-console .log-entry {
            margin: 4px 0;
            word-break: break-all;
        }

        .debug-console .log-error {
            color: #f44;
        }

        .debug-console .log-warn {
            color: #ff4;
        }

        .debug-console .log-info {
            color: #4ff;
        }

        /* Debug Console - OCULTO PARA CLIENTES
        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #009FE3;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
        }
        */

        /* Chat Flotante */
        .chat-fab {
            position: fixed;
            right: 20px;
            bottom: 88px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10B981 0%, #2DD4BF 100%);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s;
        }
        .chat-fab:hover { 
            transform: translateY(-2px); 
        }
        .chat-fab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            border-radius: 9px;
            background: #EF4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .chat-floating-panel {
            position: fixed;
            right: 20px;
            bottom: 160px;
            width: min(420px, 92vw);
            max-height: min(600px, 75vh);
            min-height: 320px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 999;
        }
        .chat-floating-header {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
            color: #fff;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-floating-close {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
        }
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            overflow-y: auto;
        }
        .message-wrapper {
            display: flex;
            width: 100%;
        }
        .message-wrapper.business {
            justify-content: flex-start;
        }
        .message-wrapper.client {
            justify-content: flex-end;
        }
        .message {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 16px;
            word-wrap: break-word;
        }
        .message.business {
            background: #f0f0f0;
            color: #333;
        }
        .message.client {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
            color: white;
        }
        .message-author {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #009FE3;
        }

        .tab.active {
            color: #009FE3;
            border-bottom-color: #009FE3;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .collection-card {
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .collection-card:hover {
            border-color: #009FE3;
            box-shadow: 0 4px 12px rgba(0, 159, 227, 0.2);
            transform: translateY(-2px);
        }

        .collection-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .collection-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .collection-card .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .collection-card .meta .badge {
            padding: 6px 10px;
            font-size: 11px;
        }

        .badge.active {
            background: #d4edda;
            color: #155724;
        }

        .badge.shared {
            background: #cce5ff;
            color: #004085;
        }

        .btn {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .collection-card .meta .btn {
            padding: 6px 12px;
            font-size: 12px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 159, 227, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .order-card {
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .order-card:hover {
            border-color: #009FE3;
            box-shadow: 0 4px 12px rgba(0, 159, 227, 0.2);
        }

        .order-card.expanded {
            border-color: #009FE3;
        }

        .order-items {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: none;
        }

        .order-card.expanded .order-items {
            display: block;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 8px;
            gap: 12px;
        }

        .order-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: #e0e0e0;
            flex-shrink: 0;
        }

        .order-item-info {
            flex: 1;
            min-width: 0;
        }

        .order-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .order-item-details {
            font-size: 12px;
            color: #666;
        }

        .order-item-price {
            font-weight: 600;
            color: #009FE3;
            flex-shrink: 0;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #009FE3;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 0;
            margin-top: 10px;
        }

        .expand-btn:hover {
            text-decoration: underline;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-header h3 {
            color: #333;
            font-size: 18px;
        }

        .order-status {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .order-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .order-status.approved {
            background: #d4edda;
            color: #155724;
        }

        .order-status.production {
            background: #cce5ff;
            color: #004085;
        }

        .order-status.delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-card.pending-highlight {
            border-color: #ffa500;
            background: linear-gradient(to right, #fff9e6 0%, white 10%);
        }

        .order-header {
            position: relative;
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .order-detail-item {
            display: flex;
            flex-direction: column;
        }

        .order-detail-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-detail-item span {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #666;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* Breadcrumbs */
        .breadcrumbs {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .breadcrumbs a {
            color: #009FE3;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s;
        }

        .breadcrumbs a:hover {
            opacity: 0.7;
        }

        .breadcrumbs span {
            color: #666;
        }

        .breadcrumbs .separator {
            color: #999;
            margin: 0 4px;
        }

        /* Vista de colecci칩n integrada */
        .collection-view {
            display: none;
            padding: 30px 20px;
            /* Asegurar que el contenido sea scrollable y no se solape */
            overflow-y: auto;
            min-height: 100vh;
        }

        .collection-view.active {
            display: block;
        }

        .collection-view-header {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .collection-view-header h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .collection-view-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        /* Productos Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            border-color: #009FE3;
            box-shadow: 0 4px 12px rgba(0, 159, 227, 0.2);
        }

        .product-card .product-image-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #f0f0f0;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 0;
            position: relative;
        }

        .product-card .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            border-radius: 12px;
        }

        /* Controles de Zoom para Accesibilidad */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid #009FE3;
            border-radius: 30px;
            padding: 8px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            transition: all 0.3s ease;
        }

        .zoom-controls:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .zoom-btn {
            background: #009FE3;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
        }

        .zoom-btn:hover {
            background: #312783;
            transform: scale(1.1);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .zoom-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .zoom-level-display {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            min-width: 50px;
            text-align: center;
            padding: 0 8px;
        }

        .zoom-reset-btn {
            background: #666;
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 20px;
        }

        .zoom-reset-btn:hover {
            background: #555;
        }

        @media (max-width: 768px) {
            .zoom-controls {
                bottom: 15px;
                right: 15px;
                padding: 6px 10px;
                gap: 6px;
            }

            .zoom-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .zoom-level-display {
                font-size: 12px;
                min-width: 45px;
                padding: 0 6px;
            }

            .zoom-reset-btn {
                font-size: 12px;
                padding: 5px 10px;
            }
        }

        /* Soporte para zoom del body */
        body {
            transition: zoom 0.3s ease;
        }

        /* Ajuste para cuando el body tiene zoom aplicado */
        html[data-zoom] {
            overflow-x: auto;
        }

        .product-card h3 {
            font-size: 18px;
            margin: 0 0 10px 0;
            color: #333;
        }

        .product-card .product-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            flex-grow: 1;
        }

        .product-card .product-price {
            font-size: 24px;
            font-weight: bold;
            color: #009FE3;
            margin: 10px 0;
        }

        .product-card .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }

        .product-card .quantity-control button {
            background: #009FE3;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .product-card .quantity-control button:hover {
            background: #312783;
            transform: scale(1.1);
        }

        .product-card .quantity-control button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .product-card .quantity-control span {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        .product-card .notes-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 10px;
        }

        .order-summary {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            /* Removido position: sticky para que el formulario fluya despu칠s de los productos */
            max-width: 100%;
        }
        
        /* Asegurar que los productos tengan espacio antes del formulario */
        #collection-products-container {
            margin-bottom: 20px;
        }

        .order-summary h3 {
            margin: 0 0 15px 0;
            font-size: 20px;
        }

        .order-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .order-summary-total {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            margin-top: 10px;
            border-top: 2px solid #009FE3;
            font-size: 20px;
            font-weight: bold;
            color: #009FE3;
        }

        .submit-order-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .submit-order-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 159, 227, 0.3);
        }

        .submit-order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Formulario de datos del pedido */
        .order-form {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #e9ecef;
        }

        .order-form h4 {
            margin: 0 0 20px 0;
            font-size: 18px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #009FE3;
            box-shadow: 0 0 0 3px rgba(0, 159, 227, 0.1);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #EF4444;
        }

        .form-group input.valid,
        .form-group select.valid,
        .form-group textarea.valid {
            border-color: #10B981;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .error-message {
            display: block;
            color: #EF4444;
            font-size: 12px;
            margin-top: 5px;
        }

        .field-hint {
            display: block;
            color: #6B7280;
            font-size: 12px;
            margin-top: 5px;
            font-style: italic;
        }

        /* Saludo temporal */
        .temporal-greeting {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .temporal-greeting h2 {
            margin: 0;
            font-size: 24px;
            color: #333;
            font-weight: 600;
        }

        /* Secci칩n de colecciones */
        .collections-section {
            padding: 30px 20px;
        }

        .collections-section h2 {
            margin: 0 0 20px 0;
            font-size: 28px;
            color: #333;
            font-weight: 700;
        }

        /* Secci칩n morada de tips (sin t칤tulo) */
        .tips-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            margin-top: 30px;
            text-align: center;
        }

        .tips-section .tips {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .tips-section .tips-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tips-section .tips-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }

        .tips-section .tips-list li {
            padding: 8px 0;
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .tips-section .tips-list li:before {
            content: "游눠";
            font-size: 18px;
        }

        /* Footer final */
        .app-footer {
            background: #2c3e50;
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-top: 40px;
            border-radius: 0 0 16px 16px;
        }

        .app-footer .footer-logo {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .app-footer .app-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #009FE3;
        }

        .app-footer .footer-tagline {
            font-size: 16px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .app-footer .footer-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .app-footer .footer-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
            opacity: 0.8;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .app-footer .footer-link:hover {
            opacity: 1;
        }

        .app-footer .footer-link svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .app-footer .footer-tips {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .app-footer .footer-tips-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.95;
        }

        .app-footer .footer-tips-content {
            font-size: 13px;
            opacity: 0.85;
            line-height: 1.6;
        }

        /* 游꿛 ESTILOS DE TEMPLATES */
        
        /* Template MODERN (Por defecto) */
        body.template-MODERN {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body.template-MODERN .header {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
        }
        body.template-MODERN .tabs button.active {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
        }
        body.template-MODERN .btn {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
        }
        body.template-MODERN .chat-fab {
            background: linear-gradient(135deg, #10B981 0%, #2DD4BF 100%);
        }
        body.template-MODERN .chat-floating-header {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
        }
        body.template-MODERN .tips-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body.template-MODERN .app-footer {
            background: #2c3e50;
        }
        body.template-MODERN .breadcrumbs {
            background: #f8f9fa;
        }
        body.template-MODERN .collection-view-header {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
        }
        body.template-MODERN .stat-card {
            background: linear-gradient(135deg, #009FE3 0%, #312783 100%);
        }
        body.template-MODERN .order-summary {
            background: #f8f9fa;
        }
        body.template-MODERN .product-card {
            border: 2px solid #eee;
        }
        body.template-MODERN .product-card:hover {
            border-color: #009FE3;
        }
        body.template-MODERN .temporal-greeting {
            background: #f8f9fa;
        }
        
        /* Template CLASSIC - Usar !important para forzar aplicaci칩n */
        body.template-CLASSIC {
            background: #f5f5f5 !important;
        }
        body.template-CLASSIC .container {
            border: 2px solid #333 !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
        }
        body.template-CLASSIC .header {
            background: #2c3e50 !important;
            border-bottom: 4px solid #34495e !important;
        }
        body.template-CLASSIC .content {
            background: white !important;
        }
        body.template-CLASSIC .collection-card {
            border: 2px solid #bdc3c7;
            background: white;
        }
        body.template-CLASSIC .collection-card:hover {
            border-color: #2c3e50;
        }
        body.template-CLASSIC .tabs button.active {
            background: #2c3e50 !important;
        }
        body.template-CLASSIC .btn {
            background: #2c3e50 !important;
        }
        body.template-CLASSIC .chat-fab {
            background: #2c3e50 !important;
        }
        body.template-CLASSIC .chat-floating-header {
            background: #2c3e50 !important;
        }
        body.template-CLASSIC .tips-section {
            background: #2c3e50 !important;
        }
        body.template-CLASSIC .app-footer {
            background: #1a1a1a !important;
        }
        body.template-CLASSIC .breadcrumbs {
            background: #ecf0f1 !important;
            border-bottom: 2px solid #bdc3c7 !important;
        }
        body.template-CLASSIC .collection-view-header {
            background: #2c3e50 !important;
            border-bottom: 4px solid #34495e !important;
        }
        body.template-CLASSIC .stat-card {
            background: #2c3e50 !important;
        }
        body.template-CLASSIC .order-summary {
            background: #ecf0f1 !important;
            border: 2px solid #bdc3c7 !important;
        }
        body.template-CLASSIC .product-card {
            border: 2px solid #bdc3c7 !important;
        }
        body.template-CLASSIC .product-card:hover {
            border-color: #2c3e50 !important;
        }
        body.template-CLASSIC .temporal-greeting {
            background: #ecf0f1 !important;
            border-bottom: 2px solid #bdc3c7 !important;
        }
        body.template-CLASSIC .order-card {
            border: 2px solid #bdc3c7 !important;
        }
        body.template-CLASSIC .order-card:hover {
            border-color: #2c3e50 !important;
        }
        
        /* Template MINIMAL */
        body.template-MINIMAL {
            background: #ffffff;
        }
        body.template-MINIMAL .container {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .header {
            background: #ffffff;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .content {
            background: #fafafa;
        }
        body.template-MINIMAL .collection-card {
            border: 1px solid #e0e0e0;
            background: #ffffff;
        }
        body.template-MINIMAL .collection-card:hover {
            border-color: #333;
            background: #f9f9f9;
        }
        body.template-MINIMAL .tabs button.active {
            background: #333;
            color: white;
        }
        body.template-MINIMAL .tabs button {
            color: #333;
        }
        body.template-MINIMAL .btn {
            background: #333;
            color: white;
        }
        body.template-MINIMAL .chat-fab {
            background: #333;
        }
        body.template-MINIMAL .chat-floating-header {
            background: #333;
        }
        body.template-MINIMAL .tips-section {
            background: #f5f5f5;
            color: #333;
        }
        body.template-MINIMAL .app-footer {
            background: #f5f5f5;
            color: #333;
        }
        body.template-MINIMAL .app-footer .app-name {
            color: #333;
        }
        body.template-MINIMAL .app-footer .footer-link {
            color: #333;
        }
        body.template-MINIMAL .breadcrumbs {
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .collection-view-header {
            background: #ffffff;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .stat-card {
            background: #ffffff;
            color: #333;
            border: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .order-summary {
            background: #ffffff;
            border: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .product-card {
            border: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .product-card:hover {
            border-color: #333;
            background: #f9f9f9;
        }
        body.template-MINIMAL .temporal-greeting {
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .order-card {
            border: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .order-card:hover {
            border-color: #333;
        }
        body.template-MINIMAL .form-group input,
        body.template-MINIMAL .form-group select,
        body.template-MINIMAL .form-group textarea {
            border: 1px solid #e0e0e0;
        }
        body.template-MINIMAL .form-group input:focus,
        body.template-MINIMAL .form-group select:focus,
        body.template-MINIMAL .form-group textarea:focus {
            border-color: #333;
        }
        
        /* Template DARK - Mejorado para legibilidad (WCAG AA) */
        body.template-DARK {
            background: #1a1a1a;
            color: #ffffff; /* Texto base blanco para m치ximo contraste */
        }
        body.template-DARK .container {
            background: #2d2d2d;
            color: #ffffff; /* Texto principal en blanco */
        }
        body.template-DARK .header {
            background: #1f2937;
            color: #ffffff !important; /* Blanco puro para m치ximo contraste */
            border-bottom: 2px solid #4a4a4a;
        }
        body.template-DARK .header h1 {
            color: #ffffff !important; /* T칤tulos en blanco */
        }
        body.template-DARK .header p {
            color: #e5e7eb !important; /* Subt칤tulos en gris muy claro */
        }
        body.template-DARK .content {
            background: #2d2d2d;
            color: #ffffff; /* Texto principal en blanco */
        }
        body.template-DARK .collections-section h2 {
            color: #ffffff !important; /* T칤tulos de secci칩n en blanco */
        }
        body.template-DARK .collection-card {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #ffffff; /* Texto principal en blanco */
        }
        body.template-DARK .collection-card h3 {
            color: #ffffff !important; /* T칤tulos de tarjetas en blanco */
        }
        body.template-DARK .collection-card p {
            color: #d1d5db !important; /* Descripciones en gris claro (alto contraste 7:1) */
            font-weight: 400;
        }
        body.template-DARK .collection-card:hover {
            border-color: #6366f1;
            background: #4a4a4a;
        }
        body.template-DARK .tabs button {
            color: #e5e7eb !important; /* Texto de tabs inactivos en gris claro */
        }
        body.template-DARK .tabs button.active {
            background: #6366f1;
            color: #ffffff !important; /* Texto activo en blanco */
        }
        body.template-DARK .btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff !important; /* Texto de botones en blanco */
        }
        body.template-DARK .chat-fab {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        body.template-DARK .chat-floating-header {
            background: #1f2937;
            color: #ffffff;
        }
        body.template-DARK .tips-section {
            background: #1f2937;
            color: #ffffff;
        }
        body.template-DARK .app-footer {
            background: #1a1a1a;
            color: #e5e7eb; /* Texto del footer en gris claro */
        }
        body.template-DARK .app-footer .app-name {
            color: #ffffff !important; /* Nombre de la app en blanco */
        }
        body.template-DARK .app-footer .footer-link {
            color: #818cf8 !important; /* Links en azul claro */
        }
        body.template-DARK .stats-card {
            background: #3a3a3a;
            color: #ffffff; /* Texto de estad칤sticas en blanco */
        }
        body.template-DARK .stats-card h3 {
            color: #ffffff !important; /* T칤tulos de estad칤sticas en blanco */
        }
        body.template-DARK .order-card {
            background: #3a3a3a;
            color: #ffffff !important; /* Texto de pedidos en blanco */
            border: 1px solid #4a4a4a;
        }
        body.template-DARK .order-card h3 {
            color: #ffffff !important; /* T칤tulos de pedidos en blanco */
        }
        body.template-DARK .order-card p {
            color: #ffffff !important; /* Texto general en blanco */
        }
        body.template-DARK .order-card p strong {
            color: #e5e7eb !important; /* Labels en gris muy claro */
        }
        body.template-DARK .order-header h3 {
            color: #ffffff !important; /* T칤tulo del pedido en blanco */
        }
        body.template-DARK .order-details {
            color: #ffffff !important; /* Texto de detalles en blanco */
        }
        body.template-DARK .order-detail-item {
            color: #ffffff !important; /* Texto de items de detalle en blanco */
        }
        body.template-DARK .order-detail-item label {
            color: #d1d5db !important; /* Labels en gris claro (alto contraste) */
        }
        body.template-DARK .order-detail-item span {
            color: #ffffff !important; /* Valores en blanco */
        }
        body.template-DARK .order-item {
            background: #4a4a4a !important; /* Fondo oscuro para items */
            border: 1px solid #5a5a5a !important;
            color: #ffffff !important;
        }
        body.template-DARK .order-item-name {
            color: #ffffff !important; /* Nombre del producto en blanco */
        }
        body.template-DARK .order-item-details {
            color: #d1d5db !important; /* Detalles en gris claro */
        }
        body.template-DARK .order-item-price {
            color: #818cf8 !important; /* Precio en azul claro */
        }
        body.template-DARK .expand-btn {
            color: #818cf8 !important; /* Bot칩n expandir en azul claro */
        }
        body.template-DARK .expand-btn:hover {
            color: #a5b4fc !important; /* Hover m치s claro */
        }
        /* Observaciones en pedidos */
        body.template-DARK .order-observations {
            background: #4a4a4a !important; /* Fondo oscuro */
            color: #ffffff !important; /* Texto en blanco */
            border: 1px solid #5a5a5a !important;
        }
        body.template-DARK .order-observations strong {
            color: #e5e7eb !important; /* Label "Observaciones" en gris claro */
        }
        body.template-DARK .order-card div[style*="background: #f0f0f0"] {
            background: #4a4a4a !important; /* Fondo oscuro (fallback) */
            color: #ffffff !important; /* Texto en blanco */
        }
        body.template-DARK .order-card div[style*="background: #f0f0f0"] strong {
            color: #e5e7eb !important; /* Label "Observaciones" en gris claro (fallback) */
        }
        /* Lista de items y totales */
        body.template-DARK .order-items-list {
            border-top-color: #5a5a5a !important; /* Borde en gris oscuro */
        }
        body.template-DARK .order-items-total {
            border-top-color: #6366f1 !important; /* Borde en azul */
            color: #818cf8 !important; /* Total en azul claro */
        }
        body.template-DARK .order-items-total span {
            color: #818cf8 !important; /* Texto del total en azul claro */
        }
        /* Productos del pedido - t칤tulo */
        body.template-DARK .order-items h4 {
            color: #ffffff !important; /* T칤tulo "Productos del pedido" en blanco */
        }
        /* Total del pedido en items */
        body.template-DARK .order-items div[style*="color: #009FE3"] {
            color: #818cf8 !important; /* Total en azul claro */
        }
        body.template-DARK .order-items div[style*="color: #009FE3"] span {
            color: #818cf8 !important; /* Texto del total en azul claro */
        }
        /* Total del pedido en order-detail-item */
        body.template-DARK .order-detail-item[style*="color: #009FE3"] {
            color: #818cf8 !important; /* Total en azul claro */
        }
        body.template-DARK .order-detail-item[style*="color: #009FE3"] span {
            color: #818cf8 !important; /* Valor del total en azul claro */
        }
        body.template-DARK .order-detail-item[style*="color: #009FE3"] label {
            color: #d1d5db !important; /* Label "Total del Pedido" en gris claro */
        }
        /* Notas y ratings dentro de order-item-details */
        body.template-DARK .order-item-note {
            color: #9ca3af !important; /* Notas en gris medio */
        }
        body.template-DARK .order-item-details div[style*="color: #999"] {
            color: #9ca3af !important; /* Notas en gris medio (fallback) */
        }
        body.template-DARK .order-item-rating {
            color: #fbbf24 !important; /* Ratings en amarillo m치s claro */
        }
        body.template-DARK .order-item-details div[style*="color: #ffa500"] {
            color: #fbbf24 !important; /* Ratings en amarillo m치s claro (fallback) */
        }
        body.template-DARK .order-item-details strong {
            color: #ffffff !important; /* Texto strong en blanco */
        }
        body.template-DARK .order-item-details div[style*="margin-bottom: 2px"] {
            color: #d1d5db !important; /* Detalles de cantidad en gris claro */
        }
        body.template-DARK .order-item-details div[style*="margin-bottom: 2px"] strong {
            color: #ffffff !important; /* Valores en blanco */
        }
        /* Icono de placeholder en order-item-image */
        body.template-DARK .order-item-image[style*="color: #999"] {
            color: #6b7280 !important; /* Icono en gris medio */
        }
        /* B칰squeda de pedidos */
        body.template-DARK #order-search {
            background: #3a3a3a !important;
            border: 1px solid #4a4a4a !important;
            color: #ffffff !important;
        }
        body.template-DARK #order-search::placeholder {
            color: #9ca3af !important;
        }
        /* Filtro de estados */
        body.template-DARK #order-status-filter {
            background: #3a3a3a !important;
            border: 1px solid #4a4a4a !important;
            color: #ffffff !important;
        }
        body.template-DARK .breadcrumbs {
            background: #2d2d2d;
            border-bottom: 1px solid #4a4a4a;
            color: #ffffff; /* Texto de breadcrumbs en blanco */
        }
        body.template-DARK .breadcrumbs a {
            color: #818cf8 !important; /* Links en azul claro */
        }
        body.template-DARK .breadcrumbs span {
            color: #d1d5db !important; /* Separadores en gris claro */
        }
        body.template-DARK .collection-view-header {
            background: #1f2937;
            border-bottom: 2px solid #3a3a3a;
            color: #ffffff;
        }
        body.template-DARK .collection-view-header h2 {
            color: #ffffff !important; /* T칤tulos en blanco */
        }
        body.template-DARK .stat-card {
            background: #3a3a3a;
            color: #ffffff; /* Texto de estad칤sticas en blanco */
        }
        body.template-DARK .stat-card h3 {
            color: #ffffff !important; /* T칤tulos de estad칤sticas en blanco */
        }
        body.template-DARK .order-summary {
            background: #2d2d2d;
            border: 1px solid #4a4a4a;
            color: #ffffff; /* Texto de resumen en blanco */
        }
        body.template-DARK .order-summary h3 {
            color: #ffffff !important; /* T칤tulos en blanco */
        }
        body.template-DARK .product-card {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #ffffff; /* Texto de productos en blanco */
        }
        body.template-DARK .product-card h3 {
            color: #ffffff !important; /* T칤tulos de productos en blanco */
        }
        body.template-DARK .product-card p {
            color: #d1d5db !important; /* Descripciones en gris claro */
        }
        body.template-DARK .product-card:hover {
            border-color: #6366f1;
            background: #4a4a4a;
        }
        body.template-DARK .temporal-greeting {
            background: #2d2d2d;
            border-bottom: 1px solid #4a4a4a;
            color: #ffffff; /* Texto del saludo en blanco */
        }
        body.template-DARK .temporal-greeting h2 {
            color: #ffffff !important; /* Saludo en blanco para m치ximo contraste */
            font-weight: 600;
        }
        body.template-DARK .form-group label {
            color: #ffffff !important; /* Labels en blanco */
        }
        body.template-DARK .form-group input,
        body.template-DARK .form-group select,
        body.template-DARK .form-group textarea {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #ffffff !important; /* Texto de inputs en blanco */
        }
        body.template-DARK .form-group input::placeholder,
        body.template-DARK .form-group textarea::placeholder {
            color: #9ca3af !important; /* Placeholders en gris medio */
        }
        body.template-DARK .form-group input:focus,
        body.template-DARK .form-group select:focus,
        body.template-DARK .form-group textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: #4a4a4a; /* Fondo m치s claro al enfocar */
        }
        body.template-DARK .search-bar input {
            background: #3a3a3a !important;
            border: 1px solid #4a4a4a !important;
            color: #ffffff !important; /* Texto de b칰squeda en blanco */
        }
        body.template-DARK .search-bar input::placeholder {
            color: #9ca3af !important; /* Placeholder en gris medio */
        }
        body.template-DARK .collection-view {
            background: #2d2d2d;
        }
        
        /* Template COLORFUL */
        body.template-COLORFUL {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
        }
        body.template-COLORFUL .header {
            background: linear-gradient(135deg, #10B981 0%, #059669 50%, #047857 100%);
        }
        body.template-COLORFUL .tabs button.active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        body.template-COLORFUL .btn {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        body.template-COLORFUL .chat-fab {
            background: linear-gradient(135deg, #10B981 0%, #2DD4BF 100%);
        }
        body.template-COLORFUL .chat-floating-header {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        body.template-COLORFUL .tips-section {
            background: linear-gradient(135deg, #10B981 0%, #059669 50%, #047857 100%);
        }
        body.template-COLORFUL .app-footer {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        }
        body.template-COLORFUL .breadcrumbs {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        body.template-COLORFUL .collection-view-header {
            background: linear-gradient(135deg, #10B981 0%, #059669 50%, #047857 100%);
        }
        body.template-COLORFUL .stat-card {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }
        body.template-COLORFUL .order-summary {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        body.template-COLORFUL .product-card {
            border: 2px solid #a7f3d0;
        }
        body.template-COLORFUL .product-card:hover {
            border-color: #10B981;
            background: #f0fdf4;
        }
        body.template-COLORFUL .temporal-greeting {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        body.template-COLORFUL .order-card {
            border: 2px solid #a7f3d0;
        }
        body.template-COLORFUL .order-card:hover {
            border-color: #10B981;
        }
        body.template-COLORFUL .form-group input:focus,
        body.template-COLORFUL .form-group select:focus,
        body.template-COLORFUL .form-group textarea:focus {
            border-color: #10B981;
        }
        body.template-COLORFUL .collection-view {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .collections-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .collection-modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            .collection-modal-header {
                border-radius: 0;
            }

            .collection-modal-iframe {
                border-radius: 0;
            }

            .temporal-greeting {
                padding: 15px;
            }

            .temporal-greeting h2 {
                font-size: 20px;
            }

            .collections-section {
                padding: 20px 15px;
            }

            .collections-section h2 {
                font-size: 24px;
            }

            .tips-section {
                padding: 20px 15px;
            }

            .tips-section .tips-list {
                text-align: center;
            }

            .tips-section .tips-list li {
                justify-content: center;
            }

            .app-footer {
                padding: 30px 15px;
            }

            .app-footer .footer-logo {
                font-size: 40px;
            }

            .app-footer .app-name {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>游녦 Bienvenido a tu Portal</h1>
            <p>Gestiona tus colecciones y pedidos en un solo lugar</p>
        </div>

        <!-- Saludo temporal (Buenos d칤as/tardes/noches) -->
        <div class="temporal-greeting" id="temporal-greeting" style="display: none;">
            <h2 id="greeting-text">Hola</h2>
        </div>

        <div class="content">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Cargando tu informaci칩n...</p>
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <!-- Debug Console - OCULTO PARA CLIENTES -->
            <!-- <button class="debug-toggle" onclick="toggleDebugConsole()" title="Mostrar/Ocultar Consola de Debug">游냍</button> -->
            <!-- <div id="debug-console" class="debug-console">
                <div style="color: #fff; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #0f0; padding-bottom: 5px;">
                    游냍 Consola de Debug
                    <button onclick="clearDebugConsole()" style="float: right; background: #f44; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">Limpiar</button>
                </div>
                <div id="debug-log"></div>
            </div> -->

            <!-- Chat Flotante Global -->
            <div id="chatFab" class="chat-fab" title="Abrir chat" aria-label="Abrir chat" style="display: none;">
                游눫
                <div id="chatFabBadge" class="chat-fab-badge">0</div>
            </div>
            <div id="chatFloatingPanel" class="chat-floating-panel" role="dialog" aria-label="Chat con el negocio">
                <div class="chat-floating-header">
                    <strong id="chatCollectionName">Chat con el negocio</strong>
                    <button id="chatFloatingClose" class="chat-floating-close" aria-label="Cerrar">九</button>
                </div>
                <div style="flex:1; padding: 12px; display:flex; flex-direction:column;">
                    <div id="chatMessagesFloating" class="chat-messages" style="flex:1; max-height: 400px; overflow-y: auto;"></div>
                    <div class="chat-input" style="margin-top:8px; display: flex; gap: 8px;">
                        <input type="text" id="chatInputFloating" placeholder="Escribe tu mensaje..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 8px;" />
                        <button id="sendMessageFloating" style="padding: 8px 16px; background: #009FE3; color: white; border: none; border-radius: 8px; cursor: pointer;">Enviar</button>
                    </div>
                </div>
            </div>

            <!-- Breadcrumbs -->
            <div class="breadcrumbs" id="breadcrumbs" style="display: none;">
                <a href="#" onclick="event.preventDefault(); showPortalView(); return false;">
                    <span>游</span> Portal
                </a>
                <span class="separator">/</span>
                <span id="breadcrumb-collection-name">Colecci칩n</span>
            </div>

            <div id="portal-content" style="display: none;">
                <!-- Tabs para Colecciones, Pedidos y Estad칤sticas -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'collections')">游닄 Mis Colecciones</button>
                    <button class="tab" onclick="switchTab(event, 'orders')">游닍 Mis Pedidos</button>
                    <button class="tab" onclick="switchTab(event, 'stats')">游늵 Estad칤sticas</button>
                </div>

                <!-- Secci칩n de Colecciones -->
                <div id="collections-tab" class="tab-content active">
                    <div class="collections-section">
                        <h2>游닄 Tus Colecciones</h2>
                        <div style="margin-bottom: 20px;">
                            <input 
                                type="text" 
                                id="collection-search" 
                                placeholder="游댌 Buscar colecciones..." 
                                style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 14px;"
                                onkeyup="filterCollections()"
                            />
                        </div>
                        <div id="collections-container" class="collections-grid"></div>
                    </div>
                </div>

                <!-- Secci칩n de Pedidos -->
                <div id="orders-tab" class="tab-content">
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <input 
                            type="text" 
                            id="order-search" 
                            placeholder="游댌 Buscar pedidos..." 
                            style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 14px;"
                            onkeyup="filterOrders()"
                        />
                        <select 
                            id="order-status-filter" 
                            style="padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 14px; cursor: pointer;"
                            onchange="filterOrders()"
                        >
                            <option value="all">Todos los estados</option>
                            <option value="APPROVED">Aprobado</option>
                            <option value="IN_PRODUCTION">En Producci칩n</option>
                            <option value="READY_FOR_DELIVERY">Listo para Entrega</option>
                            <option value="DELIVERED">Entregado</option>
                        </select>
                    </div>
                    <div id="orders-container" class="orders-list"></div>
                </div>

                <!-- Secci칩n de Estad칤sticas -->
                <div id="stats-tab" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Colecciones</h3>
                            <div class="value" id="stat-collections">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pedidos Totales</h3>
                            <div class="value" id="stat-orders">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pedidos Pendientes</h3>
                            <div class="value" id="stat-pending">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Valor Total</h3>
                            <div class="value" id="stat-total">$0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vista de Colecci칩n Integrada (FUERA de portal-content) -->
            <div class="collection-view" id="collection-view">
                <div class="collection-view-header">
                    <h2 id="collection-view-name">Colecci칩n</h2>
                    <p id="collection-view-description">Cargando...</p>
                </div>

                <div id="collection-products-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Cargando productos...</p>
                    </div>
                </div>

                <!-- Resumen de pedido -->
                <div class="order-summary" id="order-summary" style="display: none;">
                    <h3>游닍 Resumen del Pedido</h3>
                    <div id="order-summary-items"></div>
                    <div class="order-summary-total">
                        <span>Total:</span>
                        <span id="order-summary-total">$0</span>
                    </div>
                    
                    <!-- Formulario de datos del cliente -->
                    <div class="order-form" id="order-form">
                        <h4>游늶 Datos para el Pedido</h4>
                        
                        <div class="form-group">
                            <label for="order-client-name">Nombre Completo *</label>
                            <input type="text" id="order-client-name" required placeholder="Ingresa tu nombre completo">
                            <span class="error-message" id="order-client-name-error" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-client-email">Email *</label>
                            <input type="email" id="order-client-email" required placeholder="tu@email.com">
                            <span class="error-message" id="order-client-email-error" style="display: none;"></span>
                            <span class="field-hint">Usaremos este email para enviarte el detalle del pedido</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-client-phone">Tel칠fono *</label>
                            <input type="tel" id="order-client-phone" required placeholder="+56 9 1234 5678">
                            <span class="error-message" id="order-client-phone-error" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-delivery-method">M칠todo de Entrega *</label>
                            <select id="order-delivery-method" required>
                                <option value="">Selecciona...</option>
                                <option value="retiro">Retiro en tienda</option>
                                <option value="despacho">Despacho a domicilio</option>
                                <option value="evento">Entrega en evento</option>
                            </select>
                            <span class="error-message" id="order-delivery-method-error" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group" id="order-address-group" style="display: none;">
                            <label for="order-address">Direcci칩n de Entrega *</label>
                            <input type="text" id="order-address" placeholder="Calle, n칰mero, comuna, regi칩n" required>
                            <span class="error-message" id="order-address-error" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-payment-method">M칠todo de Pago *</label>
                            <select id="order-payment-method" required>
                                <option value="">Selecciona...</option>
                                <option value="efectivo">Efectivo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="link">Link de pago</option>
                                <option value="tarjeta">Tarjeta de cr칠dito/d칠bito</option>
                            </select>
                            <span class="error-message" id="order-payment-method-error" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="order-observations">Observaciones (opcional)</label>
                            <textarea id="order-observations" rows="3" placeholder="Notas adicionales para tu pedido..."></textarea>
                        </div>
                    </div>
                    
                    <button class="submit-order-btn" id="submit-order-btn" onclick="submitOrderFromPortal()">
                        Enviar Pedido
                    </button>
                </div>
            </div>

            <!-- Footer final con logo, tips breves y GitHub -->
            <div class="app-footer" id="app-footer" style="display: none;">
                <div class="footer-logo">游</div>
                <div class="app-name">NegocioListo</div>
                <div class="footer-tagline">App hecha por un emprendedor para emprendedores</div>
                
                <!-- Tips breves en el footer -->
                <div class="footer-tips">
                    <div class="footer-tips-title">游눠 쯈u칠 puedes hacer aqu칤?</div>
                    <div class="footer-tips-content">
                        Explora colecciones  Realiza pedidos  Revisa estados  Chatea con el negocio
                    </div>
                </div>
                
                <div class="footer-links">
                    <a href="https://github.com/DonGeeo87" target="_blank" rel="noopener noreferrer" class="footer-link">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                        </svg>
                        GitHub
                    </a>
                    <a href="https://github.com/DonGeeo87/NegocioListo" target="_blank" rel="noopener noreferrer" class="footer-link">
                        游님 Repositorio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles de Zoom para Accesibilidad -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="decreaseZoom()" title="Reducir zoom (-)" id="zoom-decrease-btn"></button>
        <span class="zoom-level-display" id="zoom-level-display">100%</span>
        <button class="zoom-btn" onclick="increaseZoom()" title="Aumentar zoom (+)" id="zoom-increase-btn">+</button>
        <button class="zoom-btn zoom-reset-btn" onclick="resetZoom()" title="Restablecer zoom a 100%">具</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // 游댠 Configuraci칩n de Firebase (debe coincidir con tu proyecto)
        const firebaseConfig = {
            apiKey: "AIzaSyDqwjW-scT_GgMevOV9cy7hTlmiWjfs3h8",
            authDomain: "app-negocio-listo.firebaseapp.com",
            projectId: "app-negocio-listo",
            storageBucket: "app-negocio-listo.firebasestorage.app",
            messagingSenderId: "710570364691",
            appId: "1:710570364691:web:default"
        };

        // ===== SISTEMA DE LOGGING (DEBE ESTAR PRIMERO) =====
        // Declarar variables de logging ANTES de cualquier uso
        const debugLogs = [];
        let debugConsoleVisible = false;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateDebugConsole() {
            try {
                const debugLog = document.getElementById('debug-log');
                if (debugLog) {
                    debugLog.innerHTML = debugLogs.slice(-50).map(log => {
                        const classType = `log-${log.type}`;
                        return `<div class="log-entry ${classType}">[${log.time}] ${escapeHtml(log.message)}</div>`;
                    }).join('');
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            } catch (e) {
                // Ignorar errores al actualizar la consola
            }
        }

        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            debugLogs.push(logEntry);
            
            // Tambi칠n loggear en consola del navegador (sin override para evitar loops)
            try {
                if (typeof console !== 'undefined') {
                    if (type === 'error') {
                        console.error(`[${timestamp}] ${message}`);
                    } else if (type === 'warn') {
                        console.warn(`[${timestamp}] ${message}`);
                    } else {
                        console.log(`[${timestamp}] ${message}`);
                    }
                }
            } catch (e) {
                // Ignorar errores de console
            }
            
            // Mostrar en consola de debug si el DOM est치 listo
            if (document.readyState !== 'loading') {
                updateDebugConsole();
            }
        }

        function toggleDebugConsole() {
            debugConsoleVisible = !debugConsoleVisible;
            const console = document.getElementById('debug-console');
            if (console) {
                if (debugConsoleVisible) {
                    console.classList.add('active');
                } else {
                    console.classList.remove('active');
                }
            }
        }

        function clearDebugConsole() {
            debugLogs.length = 0;
            updateDebugConsole();
        }
        // ===== FIN SISTEMA DE LOGGING =====

        // Inicializar Firebase
        let db = null;
        try {
            logDebug('游댠 Inicializando Firebase...', 'info');
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            logDebug('九 Firebase inicializado correctamente', 'info');
        } catch (error) {
            logDebug(`仇 Error inicializando Firebase: ${error.message}`, 'error');
            console.error('Error inicializando Firebase:', error);
        }

        // Obtener token de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        let customerId = null;
        let customerData = null;
        let collections = [];
        let orders = [];
        let currentCollectionId = null;
        let currentCollectionData = null;
        let collectionProducts = [];
        let selectedItems = {}; // {productId: {quantity, notes, rating}}
        let filteredCollections = [];
        let filteredOrders = [];


        // Funci칩n para cambiar de pesta침a
        function switchTab(event, tabName) {
            // Ocultar todas las pesta침as de contenido
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remover clase active de todos los botones de tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pesta침a seleccionada
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
                
                // Si se cambia a la pesta침a de pedidos, asegurar que los pedidos est칠n renderizados
                if (tabName === 'orders') {
                    logDebug('游닍 Renderizando pedidos en pesta침a de Pedidos...', 'info');
                    renderOrders();
                    updateStats(); // Actualizar estad칤sticas tambi칠n
                }
                
                // Si se cambia a la pesta침a de colecciones, renderizar colecciones
                if (tabName === 'collections') {
                    logDebug('游닄 Renderizando colecciones en pesta침a de Colecciones...', 'info');
                    renderCollections();
                }
                
                // Si se cambia a la pesta침a de estad칤sticas, actualizar estad칤sticas
                if (tabName === 'stats') {
                    logDebug('游늵 Actualizando estad칤sticas en pesta침a de Estad칤sticas...', 'info');
                    updateStats();
                }
            } else {
                logDebug(`丘멆잺 No se encontr칩 la pesta침a: ${tabName}-tab`, 'warn');
            }
            
            // Agregar clase active al bot칩n clickeado o al bot칩n correspondiente
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Si no hay event, activar el bot칩n correspondiente al tabName
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.textContent.includes(tabName === 'collections' ? 'Colecciones' : 
                                                  tabName === 'orders' ? 'Pedidos' : 'Estad칤sticas')) {
                        tab.classList.add('active');
                    }
                });
            }
            
            logDebug(`游댃 Cambiado a pesta침a: ${tabName}`, 'info');
        }

        // Funci칩n para formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Funci칩n para formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CL', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Funci칩n para obtener el estado del pedido
        function getOrderStatus(status) {
            const statusMap = {
                'APPROVED': { text: 'Aprobado', class: 'approved' },
                'IN_PRODUCTION': { text: 'En Producci칩n', class: 'production' },
                'READY_FOR_DELIVERY': { text: 'Listo para Entrega', class: 'production' },
                'DELIVERED': { text: 'Entregado', class: 'delivered' },
                'CANCELLED': { text: 'Cancelado', class: 'pending' }
            };
            return statusMap[status] || { text: status, class: 'pending' };
        }

        // Funci칩n para buscar el cliente por token
        async function findCustomerByToken() {
            try {
                logDebug(`游댌 Buscando cliente con token: ${token}`, 'info');
                
                // Buscar directamente en la colecci칩n de clientes por accessToken
                logDebug('游댍 Consultando Firestore para buscar cliente por accessToken...', 'info');
                
                try {
                    const customersSnapshot = await db.collection('customers')
                        .where('accessToken', '==', token)
                        .limit(1)
                        .get();
                    
                    if (!customersSnapshot.empty) {
                        const customerDoc = customersSnapshot.docs[0];
                        customerId = customerDoc.id;
                        customerData = customerDoc.data();
                        customerData.id = customerId;
                        
                        // Logging detallado de todos los campos del documento
                        logDebug(`九 춰CLIENTE ENCONTRADO! ID: ${customerId}`, 'info');
                        logDebug(`   游늶 Todos los campos del documento:`, 'info');
                        logDebug(`   ${JSON.stringify(customerData, null, 2)}`, 'info');
                        logDebug(`   Nombre: ${customerData.name || 'NO DEFINIDO'}`, 'info');
                        logDebug(`   Email: ${customerData.email || 'N/A'}, Tel칠fono: ${customerData.phone || 'N/A'}`, 'info');
                        
                        // 九 SIEMPRE verificar si hay un nombre m치s reciente en las colecciones asociadas
                        // Esto asegura que si el cliente fue actualizado en la app, el portal use el nombre correcto
                        try {
                            const collectionsSnapshot = await db.collection('collections')
                                .where('associatedCustomerIds', 'array-contains', customerId)
                                .limit(1)
                                .get();
                            
                            if (!collectionsSnapshot.empty) {
                                const collectionData = collectionsSnapshot.docs[0].data();
                                if (collectionData.associatedCustomerName && collectionData.associatedCustomerName.trim() !== '') {
                                    const collectionName = collectionData.associatedCustomerName.trim();
                                    // Si el nombre en la colecci칩n es diferente al del cliente, actualizar
                                    if (customerData.name !== collectionName) {
                                        logDebug(`游댃 Nombre en colecci칩n diferente al del cliente. Actualizando...`, 'info');
                                        logDebug(`   Nombre actual en cliente: "${customerData.name || 'NO DEFINIDO'}"`, 'info');
                                        logDebug(`   Nombre en colecci칩n: "${collectionName}"`, 'info');
                                        customerData.name = collectionName;
                                        
                                        // Actualizar el documento del cliente con el nombre de la colecci칩n
                                        try {
                                            await db.collection('customers').doc(customerId).update({
                                                name: collectionName
                                            });
                                            logDebug(`九 Nombre del cliente actualizado desde colecci칩n: "${collectionName}"`, 'info');
                                        } catch (updateError) {
                                            logDebug(`丘멆잺 No se pudo actualizar el nombre en Firestore: ${updateError.message}`, 'warn');
                                        }
                                        
                                        // Actualizar el saludo inmediatamente
                                        updateTemporalGreeting();
                                    }
                                }
                            }
                        } catch (error) {
                            logDebug(`丘멆잺 Error verificando nombre en colecciones: ${error.message}`, 'warn');
                        }
                        
                        // Si no tiene nombre, intentar obtenerlo desde las colecciones asociadas (fallback)
                        if (!customerData.name || customerData.name.trim() === '') {
                            logDebug(`丘멆잺 Cliente sin nombre en documento, buscando en colecciones asociadas...`, 'warn');
                            try {
                                const collectionsSnapshot = await db.collection('collections')
                                    .where('associatedCustomerIds', 'array-contains', customerId)
                                    .limit(1)
                                    .get();
                                
                                if (!collectionsSnapshot.empty) {
                                    const collectionData = collectionsSnapshot.docs[0].data();
                                    if (collectionData.associatedCustomerName && collectionData.associatedCustomerName.trim() !== '') {
                                        customerData.name = collectionData.associatedCustomerName.trim();
                                        logDebug(`九 Nombre obtenido desde colecci칩n asociada: "${customerData.name}"`, 'info');
                                        
                                        // Intentar actualizar el documento del cliente con el nombre y otros datos encontrados
                                        try {
                                            const updateData = { name: customerData.name };
                                            
                                            // Si tenemos email o tel칠fono de la colecci칩n, tambi칠n actualizarlos
                                            if (collectionData.associatedCustomerEmail) {
                                                updateData.email = collectionData.associatedCustomerEmail;
                                                customerData.email = collectionData.associatedCustomerEmail;
                                            }
                                            if (collectionData.associatedCustomerPhone) {
                                                updateData.phone = collectionData.associatedCustomerPhone;
                                                customerData.phone = collectionData.associatedCustomerPhone;
                                            }
                                            
                                            await db.collection('customers').doc(customerId).update(updateData);
                                            logDebug(`九 Datos del cliente actualizados en Firestore`, 'info');
                                        } catch (updateError) {
                                            logDebug(`丘멆잺 No se pudo actualizar el cliente en Firestore: ${updateError.message}`, 'warn');
                                        }
                                        
                                        // Actualizar el saludo inmediatamente despu칠s de encontrar el nombre
                                        updateTemporalGreeting();
                                    }
                                }
                            } catch (error) {
                                logDebug(`丘멆잺 Error buscando nombre en colecciones: ${error.message}`, 'warn');
                            }
                        }
                        
                        return customerId;
                    }
                } catch (error) {
                    logDebug(`丘멆잺 Error en b칰squeda directa por accessToken: ${error.message}`, 'warn');
                    // Continuar con b칰squeda en colecciones (compatibilidad hacia atr치s)
                }
                
                // COMPATIBILIDAD HACIA ATR츼S: Intentar extraer customerId del token
                // Formato de token antiguo: {collectionId_short}_{customerId_short}_{uuid}
                // Formato de token nuevo: {customerId_short}_{uuid}
                logDebug('游댃 Token no encontrado en clientes, intentando extraer customerId del token...', 'info');
                
                const tokenParts = token.split('_');
                if (tokenParts.length >= 2) {
                    // Si tiene 3 partes: [collectionId, customerId, uuid] - formato antiguo
                    // Si tiene 2 partes: [customerId, uuid] - formato nuevo
                    const possibleCustomerIdStart = tokenParts.length === 3 ? tokenParts[1] : tokenParts[0];
                    logDebug(`游댌 Intentando buscar cliente con ID que comience con: ${possibleCustomerIdStart}`, 'info');
                    
                    // 九 Estrategia: Cargar todas las colecciones y filtrar en JavaScript
                    // array-contains-any no funciona con prefijos de ID, as칤 que cargamos todas
                    // y filtramos por customerId parcial en JavaScript
                    // Las reglas de Firestore ahora permiten lectura p칰blica para estas consultas
                    let collectionsSnapshot;
                    try {
                        // Cargar todas las colecciones (las reglas permiten lectura p칰blica)
                        const allCollections = await db.collection('collections').get();
                        logDebug(`游닄 Total de colecciones cargadas: ${allCollections.size}`, 'info');
                        
                        // Filtrar en JavaScript: solo las que tienen associatedCustomerIds o customerAccessTokens
                        // y que coincidan con el prefijo del customerId
                        collectionsSnapshot = {
                            docs: allCollections.docs.filter(doc => {
                                const data = doc.data();
                                // Verificar si tiene clientes asociados
                                const hasAssociatedIds = data.associatedCustomerIds && data.associatedCustomerIds.length > 0;
                                const hasAccessTokens = data.customerAccessTokens && Object.keys(data.customerAccessTokens).length > 0;
                                
                                if (!hasAssociatedIds && !hasAccessTokens) return false;
                                
                                // Si tiene associatedCustomerIds, verificar si alguno coincide con el prefijo
                                if (hasAssociatedIds) {
                                    const associatedIds = Array.isArray(data.associatedCustomerIds) 
                                        ? data.associatedCustomerIds 
                                        : [data.associatedCustomerIds];
                                    const matches = associatedIds.some(id => 
                                        id.startsWith(possibleCustomerIdStart) || 
                                        possibleCustomerIdStart.startsWith(id.substring(0, 8))
                                    );
                                    if (matches) return true;
                                }
                                
                                // Si tiene customerAccessTokens, verificar si el token coincide
                                if (hasAccessTokens && data.customerAccessTokens[possibleCustomerIdStart] === token) {
                                    return true;
                                }
                                
                                return false;
                            }),
                            size: 0
                        };
                        collectionsSnapshot.size = collectionsSnapshot.docs.length;
                        logDebug(`游닄 Colecciones con clientes asociados que coinciden: ${collectionsSnapshot.size}`, 'info');
                    } catch (e) {
                        logDebug(`仇 Error cargando colecciones: ${e.message}`, 'error');
                        throw e;
                    }
                    
                    let foundCustomerId = null;
                    
                    // Filtrar solo colecciones compartidas (SHARED o ACTIVE) en JavaScript
                    const sharedCollections = collectionsSnapshot.docs.filter(doc => {
                        const data = doc.data();
                        const status = data.status || '';
                        return status === 'SHARED' || status === 'ACTIVE' || 
                               status === 'Shared' || status === 'Active';
                    });
                    
                    logDebug(`游닄 Colecciones compartidas encontradas: ${sharedCollections.length} de ${collectionsSnapshot.size}`, 'info');
                    
                    for (const collectionDoc of sharedCollections) {
                        const collectionData = collectionDoc.data();
                        const associatedIds = collectionData.associatedCustomerIds || [];
                        
                        // Manejar diferentes formatos de associatedCustomerIds
                        let customerIds = [];
                        if (Array.isArray(associatedIds)) {
                            customerIds = associatedIds;
                        } else if (typeof associatedIds === 'string') {
                            customerIds = associatedIds.split(',').filter(id => id.trim().length > 0);
                        }
                        
                        // Buscar customerId que coincida con el inicio del token
                        for (const cId of customerIds) {
                            if (cId.startsWith(possibleCustomerIdStart) || possibleCustomerIdStart.startsWith(cId.substring(0, 8))) {
                                foundCustomerId = cId;
                                logDebug(`九 Cliente encontrado por ID parcial: ${foundCustomerId}`, 'info');
                                break;
                            }
                        }
                        
                        if (foundCustomerId) break;
                    }
                    
                    // Tambi칠n buscar en customerAccessTokens de colecciones (compatibilidad)
                    if (!foundCustomerId) {
                        for (const collectionDoc of sharedCollections) {
                            const collectionData = collectionDoc.data();
                            const tokens = collectionData.customerAccessTokens || {};
                            
                            for (const [customerIdKey, tokenValue] of Object.entries(tokens)) {
                                if (tokenValue === token) {
                                    foundCustomerId = customerIdKey;
                                    logDebug(`九 Cliente encontrado en tokens de colecci칩n: ${foundCustomerId}`, 'info');
                                    break;
                                }
                            }
                            
                            if (foundCustomerId) break;
                        }
                    }
                    
                    // Si encontramos el customerId, cargar el cliente y actualizar su token
                    if (foundCustomerId) {
                        logDebug(`游늶 Cargando datos del cliente: ${foundCustomerId}`, 'info');
                        try {
                            const customerDoc = await db.collection('customers').doc(foundCustomerId).get();
                            
                            if (customerDoc.exists) {
                                customerId = foundCustomerId;
                                customerData = customerDoc.data();
                                customerData.id = customerId;
                                
                                // Logging detallado
                                logDebug(`九 Cliente cargado: ${customerData.name || 'Sin nombre'}`, 'info');
                                logDebug(`   游늶 Todos los campos: ${JSON.stringify(customerData, null, 2)}`, 'info');
                                logDebug(`   Email: ${customerData.email || 'N/A'}, Tel칠fono: ${customerData.phone || 'N/A'}`, 'info');
                                logDebug(`   Token actual: ${customerData.accessToken || 'NO TIENE'}`, 'info');
                                
                                // 九 SIEMPRE verificar si hay un nombre m치s reciente en las colecciones asociadas
                                // Esto asegura que si el cliente fue actualizado en la app, el portal use el nombre correcto
                                try {
                                    const collectionsSnapshot = await db.collection('collections')
                                        .where('associatedCustomerIds', 'array-contains', customerId)
                                        .limit(1)
                                        .get();
                                    
                                    if (!collectionsSnapshot.empty) {
                                        const collectionData = collectionsSnapshot.docs[0].data();
                                        if (collectionData.associatedCustomerName && collectionData.associatedCustomerName.trim() !== '') {
                                            const collectionName = collectionData.associatedCustomerName.trim();
                                            // Si el nombre en la colecci칩n es diferente al del cliente, actualizar
                                            if (customerData.name !== collectionName) {
                                                logDebug(`游댃 Nombre en colecci칩n diferente al del cliente. Actualizando...`, 'info');
                                                logDebug(`   Nombre actual en cliente: "${customerData.name || 'NO DEFINIDO'}"`, 'info');
                                                logDebug(`   Nombre en colecci칩n: "${collectionName}"`, 'info');
                                                customerData.name = collectionName;
                                                
                                                // Actualizar el documento del cliente con el nombre de la colecci칩n
                                                try {
                                                    await db.collection('customers').doc(customerId).update({
                                                        name: collectionName
                                                    });
                                                    logDebug(`九 Nombre del cliente actualizado desde colecci칩n: "${collectionName}"`, 'info');
                                                } catch (updateError) {
                                                    logDebug(`丘멆잺 No se pudo actualizar el nombre en Firestore: ${updateError.message}`, 'warn');
                                                }
                                                
                                                // Actualizar el saludo inmediatamente
                                                updateTemporalGreeting();
                                            }
                                        }
                                    }
                                } catch (error) {
                                    logDebug(`丘멆잺 Error verificando nombre en colecciones: ${error.message}`, 'warn');
                                }
                                
                                // Si no tiene nombre, intentar obtenerlo desde las colecciones asociadas (fallback)
                                if (!customerData.name || customerData.name.trim() === '') {
                                    logDebug(`丘멆잺 Cliente sin nombre en documento, buscando en colecciones asociadas...`, 'warn');
                                    try {
                                        const collectionsSnapshot = await db.collection('collections')
                                            .where('associatedCustomerIds', 'array-contains', customerId)
                                            .limit(1)
                                            .get();
                                        
                                        if (!collectionsSnapshot.empty) {
                                            const collectionData = collectionsSnapshot.docs[0].data();
                                            if (collectionData.associatedCustomerName && collectionData.associatedCustomerName.trim() !== '') {
                                                customerData.name = collectionData.associatedCustomerName.trim();
                                                logDebug(`九 Nombre obtenido desde colecci칩n asociada: "${customerData.name}"`, 'info');
                                                
                                                // Intentar actualizar el documento del cliente con el nombre encontrado
                                                try {
                                                    await db.collection('customers').doc(customerId).update({
                                                        name: customerData.name
                                                    });
                                                    logDebug(`九 Nombre actualizado en documento del cliente`, 'info');
                                                } catch (updateError) {
                                                    logDebug(`丘멆잺 No se pudo actualizar el nombre en Firestore: ${updateError.message}`, 'warn');
                                                }
                                                
                                                // Actualizar el saludo inmediatamente despu칠s de encontrar el nombre
                                                updateTemporalGreeting();
                                            }
                                        }
                                    } catch (error) {
                                        logDebug(`丘멆잺 Error buscando nombre en colecciones: ${error.message}`, 'warn');
                                    }
                                }
                                
                                // Actualizar el token del cliente si no lo tiene o es diferente
                                if (!customerData.accessToken || customerData.accessToken !== token) {
                                    logDebug(`游댃 Actualizando token del cliente: ${token}`, 'info');
                                    try {
                                        await db.collection('customers').doc(customerId).update({
                                            accessToken: token
                                        });
                                        customerData.accessToken = token;
                                        logDebug(`九 Token actualizado exitosamente en Firestore`, 'info');
                                    } catch (updateError) {
                                        logDebug(`丘멆잺 No se pudo actualizar el token en Firestore: ${updateError.message}`, 'warn');
                                        logDebug(`   Continuando con el token en memoria...`, 'info');
                                        // Continuar con el token en memoria aunque no se haya guardado
                                        customerData.accessToken = token;
                                    }
                                } else {
                                    logDebug(`九 El cliente ya tiene el token correcto`, 'info');
                                }
                                
                                logDebug(`九 춰CLIENTE ENCONTRADO Y CONFIGURADO! ID: ${customerId}`, 'info');
                                return customerId;
                            } else {
                                logDebug(`丘멆잺 Cliente ${foundCustomerId} no existe en la colecci칩n 'customers'`, 'warn');
                                logDebug(`   Intentando crear el cliente con datos de las colecciones asociadas...`, 'info');
                                
                                customerId = foundCustomerId;
                                
                                // Buscar datos del cliente en las colecciones asociadas
                                try {
                                    const collectionsSnapshot = await db.collection('collections')
                                        .where('associatedCustomerIds', 'array-contains', customerId)
                                        .get();
                                    
                                    logDebug(`游닄 Buscando nombre en ${collectionsSnapshot.size} colecciones asociadas...`, 'info');
                                    
                                    let foundName = null;
                                    let foundEmail = null;
                                    let foundPhone = null;
                                    
                                    // Buscar en todas las colecciones para encontrar el nombre
                                    for (const collectionDoc of collectionsSnapshot.docs) {
                                        const collectionData = collectionDoc.data();
                                        logDebug(`   Revisando colecci칩n "${collectionData.name || collectionDoc.id}"...`, 'info');
                                        logDebug(`      associatedCustomerName: ${collectionData.associatedCustomerName || 'NO DISPONIBLE'}`, 'info');
                                        
                                        if (collectionData.associatedCustomerName && collectionData.associatedCustomerName.trim() !== '') {
                                            foundName = collectionData.associatedCustomerName.trim();
                                            logDebug(`      九 Nombre encontrado: "${foundName}"`, 'info');
                                        }
                                        if (collectionData.associatedCustomerEmail && !foundEmail) {
                                            foundEmail = collectionData.associatedCustomerEmail;
                                        }
                                        if (collectionData.associatedCustomerPhone && !foundPhone) {
                                            foundPhone = collectionData.associatedCustomerPhone;
                                        }
                                        
                                        // Si encontramos el nombre, podemos parar
                                        if (foundName) break;
                                    }
                                    
                                    // Si no encontramos el nombre en colecciones, buscar en pedidos
                                    if (!foundName) {
                                        logDebug(`丘멆잺 Nombre no encontrado en colecciones, buscando en pedidos...`, 'warn');
                                        
                                        // Buscar en todas las colecciones para revisar sus pedidos
                                        for (const collectionDoc of collectionsSnapshot.docs) {
                                            const collectionId = collectionDoc.id;
                                            try {
                                                const responsesSnapshot = await db.collection(`collections/${collectionId}/responses`)
                                                    .where('customerId', '==', customerId)
                                                    .orderBy('createdAt', 'desc')
                                                    .limit(1)
                                                    .get();
                                                
                                                if (!responsesSnapshot.empty) {
                                                    const responseData = responsesSnapshot.docs[0].data();
                                                    if (responseData.clientName && responseData.clientName.trim() !== '') {
                                                        foundName = responseData.clientName.trim();
                                                        logDebug(`      九 Nombre encontrado en pedido: "${foundName}"`, 'info');
                                                        if (responseData.clientEmail && !foundEmail) {
                                                            foundEmail = responseData.clientEmail;
                                                        }
                                                        if (responseData.clientPhone && !foundPhone) {
                                                            foundPhone = responseData.clientPhone;
                                                        }
                                                        break;
                                                    }
                                                }
                                            } catch (err) {
                                                // Continuar con la siguiente colecci칩n
                                            }
                                        }
                                    }
                                    
                                    if (foundName) {
                                        // Crear documento del cliente con datos encontrados
                                        const newCustomerData = {
                                            id: customerId,
                                            name: foundName,
                                            companyName: null,
                                            phone: foundPhone || null,
                                            email: foundEmail || '', // Email requerido por reglas (puede ser string vac칤o)
                                            address: null,
                                            notes: null,
                                            createdAt: Date.now(), // Timestamp en milisegundos
                                            totalPurchases: 0.0,
                                            lastPurchaseDate: null,
                                            accessToken: token,
                                            isActive: true
                                        };
                                        
                                        try {
                                            await db.collection('customers').doc(customerId).set(newCustomerData);
                                            logDebug(`九 Cliente creado en Firestore con datos encontrados`, 'info');
                                            logDebug(`   Nombre: ${newCustomerData.name}`, 'info');
                                            
                                            customerData = newCustomerData;
                                            
                                            // Actualizar el saludo inmediatamente
                                            updateTemporalGreeting();
                                            
                                            return customerId;
                                        } catch (createError) {
                                            logDebug(`丘멆잺 No se pudo crear el cliente en Firestore: ${createError.message}`, 'warn');
                                            logDebug(`   Continuando con datos m칤nimos...`, 'info');
                                        }
                                    } else {
                                        logDebug(`丘멆잺 No se encontr칩 nombre del cliente en colecciones ni pedidos`, 'warn');
                                    }
                                } catch (error) {
                                    logDebug(`丘멆잺 Error buscando datos en colecciones: ${error.message}`, 'warn');
                                }
                                
                                // Fallback: usar datos m칤nimos si no se pudo crear
                                customerData = { 
                                    id: customerId,
                                    accessToken: token
                                };
                                logDebug(`九 Usando cliente encontrado con ID: ${customerId} (datos m칤nimos)`, 'info');
                                return customerId;
                            }
                        } catch (error) {
                            logDebug(`仇 Error cargando cliente: ${error.message}`, 'error');
                            logDebug(`   Stack: ${error.stack}`, 'error');
                            // A칰n as칤, intentar usar el ID encontrado
                            if (foundCustomerId) {
                                customerId = foundCustomerId;
                                customerData = { id: customerId };
                                customerData.accessToken = token;
                                logDebug(`九 Usando cliente encontrado a pesar del error: ${customerId}`, 'info');
                                return customerId;
                            }
                        }
                    } else {
                        logDebug(`丘멆잺 No se encontr칩 customerId que coincida con el token`, 'warn');
                    }
                }
                
                // Si ya encontramos el cliente en el paso anterior, no continuar
                if (customerId) {
                    logDebug(`九 Cliente ya identificado: ${customerId}`, 'info');
                    return customerId;
                }
                
                // 칔ltimo intento: buscar solo en colecciones compartidas por tokens
                logDebug('游댃 칔ltimo intento: buscando token en colecciones compartidas...', 'info');
                const collectionsSnapshot2 = await db.collection('collections')
                    .where('status', 'in', ['SHARED', 'ACTIVE', 'Shared', 'Active'])
                    .get();
                let tokensChecked = 0;
                
                for (const collectionDoc of collectionsSnapshot2.docs) {
                    const collectionData = collectionDoc.data();
                    const tokens = collectionData.customerAccessTokens || {};
                    const tokenCount = Object.keys(tokens).length;
                    
                    if (tokenCount > 0) {
                        for (const [customerIdKey, tokenValue] of Object.entries(tokens)) {
                            tokensChecked++;
                            if (tokenValue === token) {
                                customerId = customerIdKey;
                                logDebug(`九 춰CLIENTE ENCONTRADO (modo compatibilidad)! ID: ${customerId}`, 'info');
                                
                                try {
                                    const customerDoc = await db.collection('customers').doc(customerId).get();
                                    if (customerDoc.exists) {
                                        customerData = customerDoc.data();
                                        customerData.id = customerId;
                                        logDebug(`九 Datos del cliente cargados: ${customerData.name || 'Sin nombre'}`, 'info');
                                        logDebug(`   游늶 Todos los campos: ${JSON.stringify(customerData, null, 2)}`, 'info');
                                        
                                        // 九 SIEMPRE verificar si hay un nombre m치s reciente en las colecciones asociadas
                                        // Esto asegura que si el cliente fue actualizado en la app, el portal use el nombre correcto
                                        try {
                                            const collectionsSnapshot = await db.collection('collections')
                                                .where('associatedCustomerIds', 'array-contains', customerId)
                                                .limit(1)
                                                .get();
                                            
                                            if (!collectionsSnapshot.empty) {
                                                const collectionData = collectionsSnapshot.docs[0].data();
                                                if (collectionData.associatedCustomerName && collectionData.associatedCustomerName.trim() !== '') {
                                                    const collectionName = collectionData.associatedCustomerName.trim();
                                                    // Si el nombre en la colecci칩n es diferente al del cliente, actualizar
                                                    if (customerData.name !== collectionName) {
                                                        logDebug(`游댃 Nombre en colecci칩n diferente al del cliente. Actualizando...`, 'info');
                                                        logDebug(`   Nombre actual en cliente: "${customerData.name || 'NO DEFINIDO'}"`, 'info');
                                                        logDebug(`   Nombre en colecci칩n: "${collectionName}"`, 'info');
                                                        customerData.name = collectionName;
                                                        
                                                        // Actualizar el documento del cliente con el nombre de la colecci칩n
                                                        try {
                                                            await db.collection('customers').doc(customerId).update({
                                                                name: collectionName
                                                            });
                                                            logDebug(`九 Nombre del cliente actualizado desde colecci칩n: "${collectionName}"`, 'info');
                                                        } catch (updateError) {
                                                            logDebug(`丘멆잺 No se pudo actualizar el nombre en Firestore: ${updateError.message}`, 'warn');
                                                        }
                                                        
                                                        // Actualizar el saludo inmediatamente
                                                        updateTemporalGreeting();
                                                    }
                                                }
                                            }
                                        } catch (error) {
                                            logDebug(`丘멆잺 Error verificando nombre en colecciones: ${error.message}`, 'warn');
                                        }
                                        
                                        // Si no tiene nombre, intentar obtenerlo desde las colecciones asociadas (fallback)
                                        if (!customerData.name || customerData.name.trim() === '') {
                                            logDebug(`丘멆잺 Cliente sin nombre en documento, buscando en colecciones asociadas...`, 'warn');
                                            try {
                                                const collectionsSnapshot = await db.collection('collections')
                                                    .where('associatedCustomerIds', 'array-contains', customerId)
                                                    .limit(1)
                                                    .get();
                                                
                                                if (!collectionsSnapshot.empty) {
                                                    const collectionData = collectionsSnapshot.docs[0].data();
                                                    if (collectionData.associatedCustomerName && collectionData.associatedCustomerName.trim() !== '') {
                                                        customerData.name = collectionData.associatedCustomerName.trim();
                                                        logDebug(`九 Nombre obtenido desde colecci칩n asociada: "${customerData.name}"`, 'info');
                                                        
                                                        // Intentar actualizar el documento del cliente con el nombre encontrado
                                                        try {
                                                            await db.collection('customers').doc(customerId).update({
                                                                name: customerData.name
                                                            });
                                                            logDebug(`九 Nombre actualizado en documento del cliente`, 'info');
                                                        } catch (updateError) {
                                                            logDebug(`丘멆잺 No se pudo actualizar el nombre en Firestore: ${updateError.message}`, 'warn');
                                                        }
                                                        
                                                        // Actualizar el saludo inmediatamente despu칠s de encontrar el nombre
                                                        updateTemporalGreeting();
                                                    }
                                                }
                                            } catch (error) {
                                                logDebug(`丘멆잺 Error buscando nombre en colecciones: ${error.message}`, 'warn');
                                            }
                                        }
                                    } else {
                                        customerData = { id: customerId };
                                    }
                                } catch (error) {
                                    customerData = { id: customerId };
                                }
                                
                                return customerId;
                            }
                        }
                    }
                }
                
                // Si llegamos aqu칤 sin encontrar el cliente, lanzar error
                if (!customerId) {
                    logDebug(`仇 Token "${token}" no encontrado despu칠s de todos los intentos`, 'error');
                    throw new Error(`Token no v치lido. No se encontr칩 cliente con este token.`);
                }
            } catch (error) {
                logDebug(`仇 Error buscando cliente: ${error.message}`, 'error');
                logDebug(`   Stack: ${error.stack}`, 'error');
                throw error;
            }
        }

        // Variable global para el template del portal del cliente
        let globalTemplate = 'MODERN'; // Template por defecto
        
        // VERSI칍N DEL SCRIPT - Para verificar que se carga la versi칩n correcta
        const SCRIPT_VERSION = '2.0.1-template-fix';
        console.log(`%c游댢 NegocioListo Portal v${SCRIPT_VERSION}`, 'background: #009FE3; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
        console.log(`%c九 Script actualizado con fixes de template`, 'color: #10B981; font-weight: bold;');

        // 游꿛 FUNCI칍N PARA APLICAR TEMPLATE AL PORTAL (INTEGRAL)
        function applyTemplate(template) {
            if (!template || typeof template !== 'string') {
                logDebug('丘멆잺 Template inv치lido, usando MODERN por defecto', 'warn');
                template = 'MODERN';
            }
            
            // Normalizar el nombre del template
            const normalizedTemplate = template.toUpperCase().trim();
            
            // Remover TODAS las clases de template anteriores (forzar limpieza completa)
            const validTemplates = ['MODERN', 'CLASSIC', 'MINIMAL', 'DARK', 'COLORFUL'];
            validTemplates.forEach(t => {
                const className = `template-${t}`;
                document.body.classList.remove(className);
                
                // Remover de todos los elementos posibles
                const container = document.querySelector('.container');
                if (container) container.classList.remove(className);
                
                const header = document.querySelector('.header');
                if (header) header.classList.remove(className);
                
                const content = document.querySelector('.content');
                if (content) content.classList.remove(className);
                
                const collectionView = document.getElementById('collection-view');
                if (collectionView) collectionView.classList.remove(className);
            });
            
            // Validar y aplicar template
            const finalTemplate = validTemplates.includes(normalizedTemplate) 
                ? normalizedTemplate 
                : 'MODERN';
            
            logDebug(`游꿛 Aplicando template: ${finalTemplate} (normalizado desde: ${template})`, 'info');
            
            // FORZAR aplicaci칩n: remover todas las clases primero, luego agregar la nueva
            // Esto asegura que no haya conflictos con clases anteriores
            const allTemplateClasses = validTemplates.map(t => `template-${t}`);
            document.body.classList.remove(...allTemplateClasses);
            
            // Aplicar clase al body PRIMERO (afecta a todos los estilos base)
            document.body.classList.add(`template-${finalTemplate}`);
            logDebug(`   九 Clase agregada al body: template-${finalTemplate}`, 'info');
            
            // Verificar inmediatamente
            let bodyHasClass = document.body.classList.contains(`template-${finalTemplate}`);
            if (!bodyHasClass) {
                logDebug(`   丘멆잺 La clase no se agreg칩 al body, forzando con setAttribute...`, 'warn');
                // Forzar con setAttribute como 칰ltimo recurso
                const currentClass = document.body.className || '';
                const cleanedClass = currentClass.replace(/\btemplate-\w+/g, '').trim();
                document.body.className = cleanedClass + ` template-${finalTemplate}`;
                bodyHasClass = document.body.classList.contains(`template-${finalTemplate}`);
                logDebug(`   ${bodyHasClass ? '九' : '仇'} Clase forzada: template-${finalTemplate}`, bodyHasClass ? 'info' : 'error');
            }
            
            // Aplicar tambi칠n al container principal para mayor especificidad
            const container = document.querySelector('.container');
            if (container) {
                container.classList.remove(...allTemplateClasses);
                container.classList.add(`template-${finalTemplate}`);
                logDebug(`   九 Clase agregada al container: template-${finalTemplate}`, 'info');
            } else {
                logDebug(`   丘멆잺 Container no encontrado`, 'warn');
            }
            
            // Aplicar a elementos espec칤ficos que necesitan el template
            const header = document.querySelector('.header');
            if (header) {
                header.classList.remove(...allTemplateClasses);
                header.classList.add(`template-${finalTemplate}`);
                logDebug(`   九 Clase agregada al header: template-${finalTemplate}`, 'info');
            }
            
            const content = document.querySelector('.content');
            if (content) {
                content.classList.remove(...allTemplateClasses);
                content.classList.add(`template-${finalTemplate}`);
                logDebug(`   九 Clase agregada al content: template-${finalTemplate}`, 'info');
            }
            
            const collectionView = document.getElementById('collection-view');
            if (collectionView) {
                collectionView.classList.remove(...allTemplateClasses);
                collectionView.classList.add(`template-${finalTemplate}`);
                logDebug(`   九 Clase agregada al collection-view: template-${finalTemplate}`, 'info');
            }
            
            // Verificaci칩n final
            const finalBodyClass = document.body.className;
            const finalHasClass = finalBodyClass.includes(`template-${finalTemplate}`);
            logDebug(`   游댌 Verificaci칩n final: body.className="${finalBodyClass}"`, 'info');
            logDebug(`   游댌 쯊iene clase template-${finalTemplate}? ${finalHasClass}`, finalHasClass ? 'info' : 'error');
            
            if (!finalHasClass) {
                logDebug(`   仇 ERROR CR칈TICO: La clase template-${finalTemplate} NO se aplic칩 al body`, 'error');
                logDebug(`   游댢 Intentando aplicaci칩n de emergencia...`, 'error');
                // Aplicaci칩n de emergencia
                document.body.setAttribute('class', (document.body.className || '').replace(/\btemplate-\w+/g, '') + ` template-${finalTemplate}`);
                logDebug(`   九 Aplicaci칩n de emergencia completada`, 'info');
            }
            
            // Actualizar globalTemplate
            globalTemplate = finalTemplate;
            
            logDebug(`游꿛 Template aplicado integralmente al portal: ${finalTemplate}`, 'info');
            
            // Guardar template en localStorage para persistencia (pero no usarlo al inicio)
            try {
                localStorage.setItem('portalTemplate', finalTemplate);
                logDebug(`   游 Template guardado en localStorage: ${finalTemplate}`, 'info');
            } catch (e) {
                logDebug('丘멆잺 No se pudo guardar template en localStorage: ' + e.message, 'warn');
            }
        }

        // Funci칩n para determinar el template global del cliente
        // Prioridad: 1) Template del cliente (si existe), 2) Template m치s com칰n de colecciones, 3) MODERN por defecto
        function determineGlobalTemplate(collections, customerData = null) {
            // PRIORIDAD 1: Verificar si el cliente tiene un template preferido
            // (Preparado para cuando se agregue el campo preferredTemplate al modelo Customer)
            if (customerData && customerData.preferredTemplate) {
                const customerTemplate = customerData.preferredTemplate.toUpperCase().trim();
                const validTemplates = ['MODERN', 'CLASSIC', 'MINIMAL', 'DARK', 'COLORFUL'];
                if (validTemplates.includes(customerTemplate)) {
                    logDebug(`游꿛 Template del cliente encontrado: ${customerTemplate}`, 'info');
                    return customerTemplate;
                }
            }
            
            // PRIORIDAD 2: Determinar template m치s com칰n de las colecciones
            if (!collections || collections.length === 0) {
                logDebug('游꿛 Sin colecciones, usando template por defecto: MODERN', 'info');
                return 'MODERN'; // Template por defecto
            }
            
            // Contar la frecuencia de cada template
            const templateCounts = {};
            collections.forEach((collection, idx) => {
                const rawTemplate = collection.webTemplate || 'MODERN';
                logDebug(`   [${idx}] Analizando template: raw="${rawTemplate}" (tipo: ${typeof rawTemplate})`, 'info');
                
                // Normalizar el template: puede venir como string del enum (CLASSIC, MODERN, etc.)
                let template = String(rawTemplate).toUpperCase().trim();
                
                // Validar que sea un template v치lido
                const validTemplates = ['MODERN', 'CLASSIC', 'MINIMAL', 'DARK', 'COLORFUL'];
                const validTemplate = validTemplates.includes(template) ? template : 'MODERN';
                
                if (template !== validTemplate) {
                    logDebug(`      丘멆잺 Template "${template}" no v치lido, usando MODERN`, 'warn');
                } else {
                    logDebug(`      九 Template v치lido: ${validTemplate}`, 'info');
                }
                
                templateCounts[validTemplate] = (templateCounts[validTemplate] || 0) + 1;
            });
            
            logDebug(`   游늵 Conteo de templates: ${JSON.stringify(templateCounts)}`, 'info');
            
            // Encontrar el template m치s com칰n
            let mostCommonTemplate = 'MODERN';
            let maxCount = 0;
            Object.keys(templateCounts).forEach(template => {
                if (templateCounts[template] > maxCount) {
                    maxCount = templateCounts[template];
                    mostCommonTemplate = template;
                }
            });
            
            // Si hay empate, priorizar MODERN, luego COLORFUL, luego DARK, etc.
            if (maxCount === 0) {
                mostCommonTemplate = 'MODERN';
            } else {
                // En caso de empate, usar orden de prioridad
                const priorityOrder = ['MODERN', 'COLORFUL', 'DARK', 'CLASSIC', 'MINIMAL'];
                const tiedTemplates = Object.keys(templateCounts).filter(t => templateCounts[t] === maxCount);
                if (tiedTemplates.length > 1) {
                    for (const priorityTemplate of priorityOrder) {
                        if (tiedTemplates.includes(priorityTemplate)) {
                            mostCommonTemplate = priorityTemplate;
                            break;
                        }
                    }
                }
            }
            
            logDebug(`游꿛 Template global determinado: ${mostCommonTemplate} (usado en ${maxCount}/${collections.length} colecciones)`, 'info');
            return mostCommonTemplate;
        }

        // Listener para colecciones en tiempo real
        let collectionsListener = null;
        let isFirstSnapshot = true; // Flag para detectar el primer snapshot

        // Funci칩n para procesar colecciones y renderizar
        function processCollections(snapshot) {
            logDebug(`游닄 Procesando ${snapshot.size} colecciones`, 'info');
            
            // Guardar el template anterior para detectar cambios
            const previousTemplate = globalTemplate;
            
            collections = [];
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const rawTemplate = data.webTemplate || 'MODERN';
                logDebug(`   游늶 Colecci칩n: "${data.name || doc.id}"`, 'info');
                logDebug(`      Template RAW desde Firestore: "${rawTemplate}" (tipo: ${typeof rawTemplate})`, 'info');
                
                collections.push({
                    id: doc.id,
                    ...data,
                    webTemplate: rawTemplate // Asegurar que webTemplate est칠 presente
                });
            });

            // Determinar el template global para todas las colecciones del cliente
            // Pasar customerData para verificar si tiene template preferido
            logDebug(`游댌 Determinando template global de ${collections.length} colecciones...`, 'info');
            collections.forEach((c, idx) => {
                logDebug(`   [${idx}] "${c.name}": webTemplate="${c.webTemplate}"`, 'info');
            });
            
            const newTemplate = determineGlobalTemplate(collections, customerData);
            
            logDebug(`游꿛 Template global determinado: ${newTemplate} (anterior: ${previousTemplate})`, 'info');
            
            // SIEMPRE aplicar el template (incluso si no cambi칩) para asegurar que est칠 correcto
            // Esto corrige casos donde el template se detect칩 pero no se aplic칩 visualmente
            globalTemplate = newTemplate;
            logDebug(`游댃 Aplicando template: ${newTemplate}`, 'info');
            
            // APLICACI칍N INMEDIATA Y FORZADA
            applyTemplate(globalTemplate);
            
            // Forzar aplicaci칩n m칰ltiple veces para asegurar que se aplique
            setTimeout(() => {
                logDebug(`游댃 Re-aplicando template despu칠s de 100ms...`, 'info');
                applyTemplate(globalTemplate);
            }, 100);
            
            setTimeout(() => {
                logDebug(`游댃 Re-aplicando template despu칠s de 300ms...`, 'info');
                applyTemplate(globalTemplate);
                
                // Verificar que la clase est칠 aplicada al body
                const bodyClass = document.body.className;
                const hasClass = bodyClass.includes(`template-${newTemplate}`);
                logDebug(`游댌 Verificaci칩n post-aplicaci칩n: body.className="${bodyClass}"`, 'info');
                logDebug(`   쯊iene clase template-${newTemplate}? ${hasClass}`, hasClass ? 'info' : 'error');
                
                if (!hasClass) {
                    logDebug(`丘멆잺 La clase no se aplic칩 correctamente, forzando aplicaci칩n manual...`, 'warn');
                    // Forzar aplicaci칩n manual con setAttribute
                    const cleaned = bodyClass.replace(/\btemplate-\w+/g, '').trim();
                    document.body.setAttribute('class', cleaned + ` template-${newTemplate}`);
                    logDebug(`九 Clase forzada manualmente con setAttribute: template-${newTemplate}`, 'info');
                    
                    // Tambi칠n forzar en container y otros elementos
                    const container = document.querySelector('.container');
                    if (container) {
                        const containerClass = container.className || '';
                        const cleanedContainer = containerClass.replace(/\btemplate-\w+/g, '').trim();
                        container.setAttribute('class', cleanedContainer + ` template-${newTemplate}`);
                    }
                    
                    const header = document.querySelector('.header');
                    if (header) {
                        const headerClass = header.className || '';
                        const cleanedHeader = headerClass.replace(/\btemplate-\w+/g, '').trim();
                        header.setAttribute('class', cleanedHeader + ` template-${newTemplate}`);
                    }
                    
                    // Verificar nuevamente
                    const finalCheck = document.body.className.includes(`template-${newTemplate}`);
                    logDebug(`   游댌 Verificaci칩n final: ${finalCheck ? '九' : '仇'}`, finalCheck ? 'info' : 'error');
                } else {
                    logDebug(`九 Template aplicado correctamente`, 'info');
                }
            }, 300);
            
            // NO sobrescribir los templates de las colecciones - mantener los valores reales de Firestore
            // Esto permite que determineGlobalTemplate funcione correctamente en la pr칩xima actualizaci칩n

            filteredCollections = collections;
            renderCollections();
            updateStats();
            
            // Mostrar bot칩n de chat si hay alguna colecci칩n con chat habilitado
            const hasChatEnabled = collections.some(c => c.enableChat);
            const chatFab = document.getElementById('chatFab');
            if (hasChatEnabled && chatFab) {
                chatFab.style.display = 'flex';
            }
            
            logDebug(`九 Colecciones procesadas: ${collections.length} con template global: ${globalTemplate}`, 'info');
        }

        // Funci칩n para cargar y observar colecciones del cliente en tiempo real
        async function loadCollections() {
            try {
                // Validar que customerId est칠 disponible
                if (!customerId) {
                    logDebug(`仇 No se puede cargar colecciones: customerId no est치 disponible`, 'error');
                    collections = [];
                    filteredCollections = [];
                    renderCollections();
                    updateStats();
                    return;
                }
                
                logDebug(`游닄 Cargando colecciones para cliente: ${customerId}`, 'info');
                
                // PRIMERO: Cargar colecciones inmediatamente usando el m칠todo fallback
                // Esto asegura que las colecciones se carguen de inmediato
                await loadCollectionsFallback();
                
                // DESPU칄S: Configurar listener en tiempo real para actualizaciones futuras
                logDebug(`游닄 Configurando listener en tiempo real para actualizaciones...`, 'info');
                
                // Cancelar listener anterior si existe
                if (collectionsListener) {
                    collectionsListener();
                    collectionsListener = null;
                }
                
                // Configurar listener en tiempo real para actualizaciones
                try {
                    logDebug(`   游댌 Configurando listener en tiempo real para customerId: ${customerId}`, 'info');
                    const collectionsQuery = db.collection('collections')
                        .where('associatedCustomerIds', 'array-contains', customerId);
                    
                    isFirstSnapshot = true; // Resetear flag
                    collectionsListener = collectionsQuery.onSnapshot(
                        (snapshot) => {
                            // Ignorar el primer snapshot ya que ya cargamos las colecciones
                            if (isFirstSnapshot) {
                                isFirstSnapshot = false;
                                logDebug(`游닄 Primer snapshot recibido (ignorado, ya cargamos las colecciones)`, 'info');
                                return;
                            }
                            
                            logDebug(`游닄 Colecciones actualizadas en tiempo real: ${snapshot.size} colecciones`, 'info');
                            processCollections(snapshot);
                        },
                        (error) => {
                            logDebug(`丘멆잺 Error en listener de colecciones: ${error.message}`, 'warn');
                            logDebug(`   Stack: ${error.stack}`, 'warn');
                            logDebug(`   Continuando con colecciones ya cargadas...`, 'info');
                            // No hacer nada, ya tenemos las colecciones cargadas
                        }
                    );
                    
                    logDebug(`九 Listener en tiempo real configurado correctamente`, 'info');
                } catch (queryError) {
                    logDebug(`丘멆잺 Error configurando listener en tiempo real: ${queryError.message}`, 'warn');
                    logDebug(`   Stack: ${queryError.stack}`, 'warn');
                    logDebug(`   Continuando con colecciones ya cargadas...`, 'info');
                    // No hacer nada, ya tenemos las colecciones cargadas
                }
            } catch (error) {
                logDebug(`仇 Error cargando colecciones: ${error.message}`, 'error');
                logDebug(`   Stack: ${error.stack}`, 'error');
                // Continuar sin colecciones
                collections = [];
                filteredCollections = [];
                globalTemplate = 'MODERN';
                renderCollections();
                updateStats();
            }
        }

        // Funci칩n de fallback para cargar colecciones una sola vez
        async function loadCollectionsFallback() {
            try {
                // Validar que customerId est칠 disponible
                if (!customerId) {
                    logDebug(`仇 No se puede cargar colecciones: customerId no est치 disponible`, 'error');
                    collections = [];
                    filteredCollections = [];
                    renderCollections();
                    updateStats();
                    return;
                }
                
                logDebug(`游닄 Cargando colecciones (modo fallback) para cliente: ${customerId}`, 'info');
                logDebug(`   Tipo de customerId: ${typeof customerId}`, 'info');
                logDebug(`   Valor de customerId: "${customerId}"`, 'info');
                
                let collectionsSnapshot;
                try {
                    // Intentar consulta con array-contains
                    logDebug(`   游댌 Ejecutando consulta Firestore: collections.where('associatedCustomerIds', 'array-contains', '${customerId}')`, 'info');
                    collectionsSnapshot = await db.collection('collections')
                        .where('associatedCustomerIds', 'array-contains', customerId)
                        .get();
                    
                    logDebug(`游닄 Consulta Firestore exitosa: ${collectionsSnapshot.size} colecciones encontradas`, 'info');
                    
                    // Si no se encontraron colecciones, intentar cargar todas y filtrar manualmente
                    if (collectionsSnapshot.size === 0) {
                        logDebug(`   丘멆잺 No se encontraron colecciones con array-contains, intentando cargar todas...`, 'warn');
                        const allCollections = await db.collection('collections').get();
                        // Filtrar en JavaScript: solo las que tienen associatedCustomerIds y el customerId
                        const filtered = allCollections.docs.filter(doc => {
                            const data = doc.data();
                            const customerIds = data.associatedCustomerIds || [];
                            if (Array.isArray(customerIds)) {
                                return customerIds.includes(customerId);
                            } else if (typeof customerIds === 'string') {
                                return customerIds.split(',').map(id => id.trim()).includes(customerId);
                            }
                            return false;
                        });
                        collectionsSnapshot = {
                            docs: filtered,
                            size: filtered.length
                        };
                        logDebug(`   游늶 Total de colecciones filtradas: ${collectionsSnapshot.size}`, 'info');
                        
                        // Ya est치 filtrado arriba, pero verificar formato de customerIds
                        const filteredDocs = collectionsSnapshot.docs.filter(doc => {
                            const data = doc.data();
                            const customerIds = data.associatedCustomerIds || [];
                            
                            // Manejar diferentes formatos
                            if (Array.isArray(customerIds)) {
                                const includes = customerIds.includes(customerId);
                                if (includes) {
                                    logDebug(`   九 Colecci칩n "${data.name || doc.id}" coincide con customerId`, 'info');
                                }
                                return includes;
                            } else if (typeof customerIds === 'string') {
                                const matches = customerIds === customerId;
                                if (matches) {
                                    logDebug(`   九 Colecci칩n "${data.name || doc.id}" coincide con customerId (string)`, 'info');
                                }
                                return matches;
                            } else if (customerIds && typeof customerIds === 'object') {
                                // Podr칤a ser un objeto con propiedades
                                const values = Object.values(customerIds);
                                const includes = values.includes(customerId);
                                if (includes) {
                                    logDebug(`   九 Colecci칩n "${data.name || doc.id}" coincide con customerId (objeto)`, 'info');
                                }
                                return includes;
                            }
                            
                            return false;
                        });
                        
                        logDebug(`   九 Colecciones filtradas manualmente: ${filteredDocs.length}`, 'info');
                        collectionsSnapshot = {
                            docs: filteredDocs,
                            size: filteredDocs.length
                        };
                    }
                } catch (queryError) {
                    logDebug(`丘멆잺 Error en consulta de colecciones: ${queryError.message}`, 'warn');
                    logDebug(`   Stack: ${queryError.stack}`, 'warn');
                    // Si falla la consulta, intentar cargar todas y filtrar en JavaScript
                    logDebug(`   Intentando cargar todas las colecciones...`, 'info');
                    const allCollectionsRaw = await db.collection('collections').get();
                    logDebug(`   游늶 Total de colecciones en Firestore: ${allCollectionsRaw.size}`, 'info');
                    
                    // Filtrar en JavaScript: solo las que tienen associatedCustomerIds y el customerId
                    const filtered = allCollectionsRaw.docs.filter(doc => {
                        const data = doc.data();
                        const customerIds = data.associatedCustomerIds || [];
                        
                        // Log para debugging
                        if (allCollectionsRaw.docs.indexOf(doc) < 3) { // Solo log de las primeras 3
                            logDebug(`   游댌 Revisando colecci칩n "${data.name || doc.id}": associatedCustomerIds = ${JSON.stringify(customerIds)}`, 'info');
                        }
                        
                        if (Array.isArray(customerIds)) {
                            return customerIds.includes(customerId);
                        } else if (typeof customerIds === 'string') {
                            return customerIds.split(',').map(id => id.trim()).includes(customerId);
                        }
                        return false;
                    });
                    
                    collectionsSnapshot = {
                        docs: filtered,
                        size: filtered.length
                    };
                    logDebug(`   九 Colecciones encontradas despu칠s del fallback: ${collectionsSnapshot.size}`, 'info');
                }

                logDebug(`游닄 Colecciones encontradas para el cliente: ${collectionsSnapshot.size}`, 'info');
                
                collections = [];
                collectionsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const rawTemplate = data.webTemplate || 'MODERN';
                    logDebug(`   游늶 Colecci칩n: "${data.name || doc.id}"`, 'info');
                    logDebug(`      Template RAW desde Firestore: "${rawTemplate}" (tipo: ${typeof rawTemplate})`, 'info');
                    
                    collections.push({
                        id: doc.id,
                        ...data,
                        webTemplate: rawTemplate // Asegurar que webTemplate est칠 presente
                    });
                });

                // Determinar el template global para todas las colecciones del cliente
                // Pasar customerData para verificar si tiene template preferido
                logDebug(`游댌 Determinando template global de ${collections.length} colecciones (fallback)...`, 'info');
                collections.forEach((c, idx) => {
                    logDebug(`   [${idx}] "${c.name}": webTemplate="${c.webTemplate}"`, 'info');
                });
                
                globalTemplate = determineGlobalTemplate(collections, customerData);
                
                logDebug(`游꿛 Template global determinado (fallback): ${globalTemplate}`, 'info');
                logDebug(`游꿛 Aplicando template al portal (fallback)...`, 'info');
                
                // Aplicar el template al portal inmediatamente (integralmente)
                applyTemplate(globalTemplate);
                
                // NO sobrescribir los templates de las colecciones - mantener los valores reales de Firestore
                // Esto permite que determineGlobalTemplate funcione correctamente en la pr칩xima actualizaci칩n
                // collections.forEach(collection => {
                //     collection.webTemplate = globalTemplate;
                // });

                filteredCollections = collections;
                renderCollections();
                updateStats();
                
                // Mostrar bot칩n de chat si hay alguna colecci칩n con chat habilitado
                const hasChatEnabled = collections.some(c => c.enableChat);
                const chatFab = document.getElementById('chatFab');
                if (hasChatEnabled && chatFab) {
                    chatFab.style.display = 'flex';
                }
                
                logDebug(`九 Colecciones cargadas: ${collections.length} con template global: ${globalTemplate}`, 'info');
            } catch (error) {
                logDebug(`仇 Error cargando colecciones: ${error.message}`, 'error');
                logDebug(`   Stack: ${error.stack}`, 'error');
                // No mostrar error cr칤tico, solo continuar sin colecciones
                collections = [];
                filteredCollections = [];
                globalTemplate = 'MODERN';
                renderCollections();
                updateStats();
            }
        }

        // Funci칩n para filtrar colecciones
        function filterCollections() {
            const searchTerm = document.getElementById('collection-search').value.toLowerCase();
            filteredCollections = collections.filter(collection => {
                const name = (collection.name || '').toLowerCase();
                const description = (collection.description || '').toLowerCase();
                return name.includes(searchTerm) || description.includes(searchTerm);
            });
            renderCollections();
        }

        // Funci칩n para renderizar colecciones
        function renderCollections() {
            const container = document.getElementById('collections-container');
            
            // Validar que el contenedor exista
            if (!container) {
                logDebug(`仇 No se puede renderizar colecciones: el contenedor no existe`, 'error');
                return;
            }
            
            const collectionsToRender = filteredCollections.length > 0 ? filteredCollections : collections;
            
            logDebug(`游꿛 Renderizando ${collectionsToRender.length} colecciones (total: ${collections.length}, filtradas: ${filteredCollections.length})`, 'info');
            
            if (collectionsToRender.length === 0) {
                logDebug(`丘멆잺 No hay colecciones para renderizar`, 'warn');
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No se encontraron colecciones</h3>
                        <p>${collections.length === 0 ? 'Las colecciones aparecer치n aqu칤 cuando el negocio te asigne alguna.' : 'Intenta con otros t칠rminos de b칰squeda.'}</p>
                    </div>
                `;
                return;
            }

            // Contar pedidos pendientes por colecci칩n
            const pendingOrdersByCollection = {};
            orders.forEach(order => {
                if (order.status === 'APPROVED' && order.collectionId) {
                    if (!pendingOrdersByCollection[order.collectionId]) {
                        pendingOrdersByCollection[order.collectionId] = 0;
                    }
                    pendingOrdersByCollection[order.collectionId]++;
                }
            });

            container.innerHTML = collectionsToRender.map(collection => {
                // Determinar estado basado en pedidos pendientes
                const pendingCount = pendingOrdersByCollection[collection.id] || 0;
                let statusBadge = '';
                if (pendingCount > 0) {
                    statusBadge = `<span class="badge pending" style="background: #ff9800; color: white; white-space: nowrap;">游닍 ${pendingCount} Pedido${pendingCount > 1 ? 's' : ''} Pendiente${pendingCount > 1 ? 's' : ''}</span>`;
                } else if (collection.status === 'ACTIVE') {
                    statusBadge = '<span class="badge active">Activa</span>';
                } else if (collection.status === 'SHARED') {
                    statusBadge = '<span class="badge shared">Compartida</span>';
                }

                // Usar el token del cliente (token global) ya que ahora es 칰nico por cliente
                // El token viene de la URL y est치 disponible en el scope global
                const urlToken = new URLSearchParams(window.location.search).get('token') || '';
                const collectionToken = customerData?.accessToken || urlToken;
                
                // Construir URL completa de la colecci칩n
                // IMPORTANTE: Siempre usar el template global del cliente para mantener consistencia
                // Esto asegura que todas las colecciones del cliente usen el mismo template
                const baseUrl = window.location.origin;
                // Usar el template global actualizado (no el individual de la colecci칩n)
                const template = globalTemplate || 'MODERN';
                const collectionUrl = `${baseUrl}/collection.html?id=${encodeURIComponent(collection.id)}&token=${encodeURIComponent(collectionToken)}&template=${encodeURIComponent(template)}`;
                
                logDebug(`游댕 URL de colecci칩n generada: ${collectionUrl} (template global: ${template})`, 'info');
                
                // Mostrar bot칩n de chat flotante si hay alguna colecci칩n con chat
                if (collection.enableChat) {
                    const chatFab = document.getElementById('chatFab');
                    if (chatFab) chatFab.style.display = 'flex';
                }

                // Escapar valores para atributos HTML data-*
                const escapedId = collection.id.replace(/"/g, '&quot;');
                const escapedName = (collection.name || 'Colecci칩n').replace(/"/g, '&quot;');
                
                return `
                    <div class="collection-card">
                        <h3>${collection.name || 'Sin nombre'}</h3>
                        <p>${collection.description || 'Sin descripci칩n'}</p>
                        <div class="meta">
                            ${statusBadge}
                            <button class="btn view-collection-btn" 
                                    data-collection-id="${escapedId}">
                                Ver Colecci칩n 
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Verificar que el HTML se haya insertado correctamente
            const htmlLength = container.innerHTML.length;
            const collectionCards = container.querySelectorAll('.collection-card');
            logDebug(`九 ${collectionsToRender.length} colecciones renderizadas en el DOM`, 'info');
            logDebug(`   - HTML insertado: ${htmlLength} caracteres`, 'info');
            logDebug(`   - Tarjetas encontradas en DOM: ${collectionCards.length}`, 'info');
            
            // Verificar visibilidad del contenedor
            const containerStyle = window.getComputedStyle(container);
            const isVisible = containerStyle.display !== 'none' && containerStyle.visibility !== 'hidden';
            logDebug(`   - Contenedor visible: ${isVisible} (display: ${containerStyle.display}, visibility: ${containerStyle.visibility})`, isVisible ? 'info' : 'warn');
            
            if (collectionCards.length !== collectionsToRender.length) {
                logDebug(`丘멆잺 ADVERTENCIA: Se esperaban ${collectionsToRender.length} tarjetas pero se encontraron ${collectionCards.length} en el DOM`, 'warn');
            }
        }

        // Funci칩n para cargar pedidos del cliente
        async function loadOrders() {
            try {
                logDebug(`游닍 Cargando pedidos para cliente: ${customerId}`, 'info');
                
                // Obtener datos del cliente para buscar por email/tel칠fono tambi칠n
                const customerEmail = customerData?.email || null;
                const customerPhone = customerData?.phone || null;
                
                const ordersSnapshot = await db.collection('collections')
                    .get();

                logDebug(`游닍 Revisando ${ordersSnapshot.size} colecciones para pedidos...`, 'info');
                
                orders = [];
                
                // Crear un Set para evitar pedidos duplicados
                const orderIds = new Set();
                
                for (const collectionDoc of ordersSnapshot.docs) {
                    try {
                        const collectionData = collectionDoc.data();
                        // Solo buscar en colecciones asociadas al cliente o en todas si no tenemos customerId
                        const isAssociated = !customerId || 
                            (collectionData.associatedCustomerIds && 
                             Array.isArray(collectionData.associatedCustomerIds) && 
                             collectionData.associatedCustomerIds.includes(customerId));
                        
                        if (!isAssociated && customerId) {
                            continue; // Saltar colecciones no asociadas
                        }
                        
                        // Obtener TODOS los pedidos de esta colecci칩n
                        const allResponses = await collectionDoc.ref
                            .collection('responses')
                            .get();
                        
                        logDebug(`   游댌 Revisando ${allResponses.size} pedidos en "${collectionData.name || collectionDoc.id}"...`, 'info');
                        
                        allResponses.forEach(doc => {
                            const data = doc.data();
                            
                            // Verificar si el pedido pertenece al cliente
                            const matchesCustomerId = customerId && data.customerId === customerId;
                            const matchesEmail = customerEmail && data.clientEmail && 
                                                 data.clientEmail.toLowerCase().trim() === customerEmail.toLowerCase().trim();
                            const matchesPhone = customerPhone && data.clientPhone && 
                                                data.clientPhone.replace(/\s/g, '').replace(/[^0-9]/g, '') === 
                                                customerPhone.replace(/\s/g, '').replace(/[^0-9]/g, '');
                            const matchesToken = token && (data.accessToken === token || data.token === token);
                            
                            // Si la colecci칩n est치 asociada al cliente y el pedido no tiene customerId,
                            // asumir que es del cliente (para pedidos antiguos)
                            const isCollectionAssociated = isAssociated;
                            const hasNoCustomerId = !data.customerId || data.customerId === null;
                            const matchesCollectionAssociation = isCollectionAssociated && hasNoCustomerId && customerId;
                            
                            // Log detallado para debugging (solo para los que no coinciden)
                            const matches = matchesCustomerId || matchesEmail || matchesPhone || matchesToken || matchesCollectionAssociation;
                            if (!matches) {
                                logDebug(`   丘멆잺 Pedido ${doc.id.substring(0, 8)} NO coincide:`, 'warn');
                                logDebug(`      customerId pedido: "${data.customerId || 'null'}" vs buscado: "${customerId || 'null'}"`, 'warn');
                                logDebug(`      email pedido: "${data.clientEmail || 'null'}" vs buscado: "${customerEmail || 'null'}"`, 'warn');
                                logDebug(`      tel칠fono pedido: "${data.clientPhone || 'null'}" vs buscado: "${customerPhone || 'null'}"`, 'warn');
                                logDebug(`      token pedido: "${data.accessToken || data.token || 'null'}" vs buscado: "${token || 'null'}"`, 'warn');
                                logDebug(`      colecci칩n asociada: ${isCollectionAssociated}, sin customerId: ${hasNoCustomerId}`, 'warn');
                            }
                            
                            if (matches) {
                                // Evitar duplicados
                                if (!orderIds.has(doc.id)) {
                                    orderIds.add(doc.id);
                                    orders.push({
                                        id: doc.id,
                                        collectionId: collectionDoc.id,
                                        collectionName: collectionData.name || collectionDoc.id,
                                        ...data
                                    });
                                    const matchType = matchesCustomerId ? 'customerId' : 
                                                     matchesEmail ? 'email' : 
                                                     matchesPhone ? 'phone' : 
                                                     matchesToken ? 'token' : 
                                                     'colecci칩n-asociada';
                                    logDebug(`   九 Pedido encontrado: ${doc.id.substring(0, 8)}... (match: ${matchType})`, 'info');
                                }
                            }
                        });
                    } catch (error) {
                        logDebug(`   丘멆잺 Error cargando pedidos de "${collectionDoc.id}": ${error.message}`, 'warn');
                    }
                }

                // Ordenar por fecha de creaci칩n (m치s recientes primero)
                orders.sort((a, b) => {
                    const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    return dateB - dateA;
                });

                filteredOrders = orders;
                await renderOrders();
                updateStats();
                logDebug(`九 Pedidos cargados: ${orders.length}`, 'info');
            } catch (error) {
                logDebug(`仇 Error cargando pedidos: ${error.message}`, 'error');
                showError('Error al cargar los pedidos');
            }
        }

        // Funci칩n para filtrar pedidos
        async function filterOrders() {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const statusFilter = document.getElementById('order-status-filter').value;
            
            // Primero filtrar por estado
            let tempFiltered = orders.filter(order => {
                return statusFilter === 'all' || order.status === statusFilter;
            });
            
            // Luego filtrar por b칰squeda (incluyendo n칰mero de pedido)
            filteredOrders = tempFiltered.filter((order, index) => {
                if (!searchTerm) return true;
                
                // Incluir b칰squeda por n칰mero de pedido (01, 02, etc.) basado en el 칤ndice en el array filtrado
                const orderNumber = String(index + 1).padStart(2, '0');
                const matchesOrderNumber = orderNumber.includes(searchTerm);
                
                // Buscar en otros campos
                const matchesOtherFields = 
                    (order.collectionName || '').toLowerCase().includes(searchTerm) ||
                    order.id.toLowerCase().includes(searchTerm);
                
                return matchesOrderNumber || matchesOtherFields;
            });
            
            await renderOrders();
        }

        // Cache de productos para evitar m칰ltiples consultas
        const productsCache = new Map();

        // Funci칩n para cargar informaci칩n completa de un producto
        async function loadProductInfo(productId) {
            // Si ya est치 en cache, retornar inmediatamente
            if (productsCache.has(productId)) {
                return productsCache.get(productId);
            }

            try {
                // Buscar el producto en la colecci칩n de productos
                const productDoc = await db.collection('products').doc(productId).get();
                
                if (productDoc.exists) {
                    const productData = productDoc.data();
                    const productInfo = {
                        name: productData.name || 'Producto',
                        imageUrl: productData.photoUrl || productData.imageUrl || productData.thumbnailUrl || null,
                        salePrice: productData.salePrice || productData.price || 0
                    };
                    productsCache.set(productId, productInfo);
                    logDebug(`   九 Producto cargado: ${productInfo.name} - Precio: ${productInfo.salePrice}`, 'info');
                    return productInfo;
                }

                // Si no se encuentra en productos, buscar en la colecci칩n actual
                // (algunos productos pueden estar solo en la colecci칩n)
                logDebug(`   丘멆잺 Producto ${productId.substring(0, 8)} no encontrado en products, buscando en colecciones...`, 'warn');
                
                // Retornar info b치sica si no se encuentra
                const basicInfo = { name: 'Producto', imageUrl: null, salePrice: 0 };
                productsCache.set(productId, basicInfo);
                return basicInfo;
            } catch (error) {
                logDebug(`   仇 Error cargando producto ${productId.substring(0, 8)}: ${error.message}`, 'error');
                const errorInfo = { name: 'Producto', imageUrl: null, salePrice: 0 };
                productsCache.set(productId, errorInfo);
                return errorInfo;
            }
        }

        // Funci칩n para cargar informaci칩n de productos de una colecci칩n
        async function loadProductsFromCollection(collectionId) {
            try {
                const collectionDoc = await db.collection('collections').doc(collectionId).get();
                if (!collectionDoc.exists) return;

                const collectionData = collectionDoc.data();
                const products = collectionData.products || {};

                // Agregar productos de la colecci칩n al cache
                Object.entries(products).forEach(([productId, productData]) => {
                    // Si ya est치 en cache, actualizar solo si no tiene precio
                    if (productsCache.has(productId)) {
                        const cached = productsCache.get(productId);
                        // Si el producto cacheado no tiene precio pero este s칤, actualizarlo
                        if ((!cached.salePrice || cached.salePrice === 0) && (productData.salePrice || productData.price)) {
                            cached.salePrice = productData.salePrice || productData.price || 0;
                            productsCache.set(productId, cached);
                            logDebug(`   九 Precio actualizado para producto ${productId.substring(0, 8)}: ${cached.salePrice}`, 'info');
                        }
                    } else {
                        // Agregar nuevo producto al cache con precio
                        const productInfo = {
                            name: productData.name || 'Producto',
                            imageUrl: productData.imageUrl || productData.photoUrl || productData.thumbnailUrl || null,
                            salePrice: productData.salePrice || productData.price || 0
                        };
                        productsCache.set(productId, productInfo);
                        logDebug(`   九 Producto de colecci칩n cargado: ${productInfo.name} - Precio: ${productInfo.salePrice}`, 'info');
                    }
                });
            } catch (error) {
                logDebug(`   丘멆잺 Error cargando productos de colecci칩n ${collectionId.substring(0, 8)}: ${error.message}`, 'warn');
            }
        }

        // Funci칩n para renderizar pedidos
        async function renderOrders() {
            const container = document.getElementById('orders-container');
            const ordersToRender = filteredOrders.length > 0 ? filteredOrders : orders;
            
            // Guardar estado de expansi칩n antes de renderizar
            const expandedOrders = new Set();
            document.querySelectorAll('.order-card.expanded').forEach(card => {
                const orderIndex = card.id.replace('order-', '');
                if (orderIndex !== '') {
                    expandedOrders.add(parseInt(orderIndex));
                }
            });
            
            if (ordersToRender.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No se encontraron pedidos</h3>
                        <p>${orders.length === 0 ? 'Cuando realices un pedido desde una colecci칩n, aparecer치 aqu칤.' : 'Intenta con otros t칠rminos de b칰squeda o filtros.'}</p>
                    </div>
                `;
                return;
            }

            // Cargar informaci칩n de productos de todas las colecciones 칰nicas PRIMERO
            const uniqueCollectionIds = new Set(ordersToRender.map(o => o.collectionId));
            logDebug(`游닍 Cargando productos de ${uniqueCollectionIds.size} colecciones 칰nicas...`, 'info');
            await Promise.all(Array.from(uniqueCollectionIds).map(id => loadProductsFromCollection(id)));
            logDebug(`九 Productos de colecciones cargados en cache`, 'info');
            
            // Tambi칠n cargar productos individuales que no est칠n en cache
            const allProductIds = new Set();
            ordersToRender.forEach(order => {
                const items = order.items || {};
                Object.keys(items).forEach(productId => allProductIds.add(productId));
            });
            logDebug(`游닍 Cargando informaci칩n de ${allProductIds.size} productos 칰nicos...`, 'info');
            await Promise.all(Array.from(allProductIds).map(id => loadProductInfo(id)));
            logDebug(`九 Todos los productos cargados`, 'info');

            // Renderizar pedidos con numeraci칩n secuencial y preservando estado de expansi칩n
            const ordersHtml = await Promise.all(ordersToRender.map(async (order, index) => {
                const status = getOrderStatus(order.status || 'APPROVED');
                const items = order.items || {};
                const isPending = false;
                const orderNumber = String(index + 1).padStart(2, '0');

                // Renderizar items del pedido con informaci칩n completa y calcular totales
                const itemsData = await Promise.all(Object.entries(items).map(async ([productId, item]) => {
                    const quantity = item.quantity || 0;
                    
                    // Cargar informaci칩n completa del producto
                    const productInfo = await loadProductInfo(productId);
                    const productName = productInfo.name || item.name || 'Producto';
                    const productImageUrl = productInfo.imageUrl || item.imageUrl || item.photoUrl || null;
                    
                    // Buscar precio en el siguiente orden de prioridad:
                    // 1. En el item del pedido (precio guardado cuando se hizo el pedido)
                    // 2. En el producto cacheado de la colecci칩n
                    // 3. En el producto cacheado global
                    let productPrice = 0;
                    
                    // Prioridad 1: Precio en el item del pedido
                    if (item.salePrice && item.salePrice > 0) {
                        productPrice = item.salePrice;
                    } else if (item.price && item.price > 0) {
                        productPrice = item.price;
                    }
                    
                    // Prioridad 2: Precio en el producto cacheado
                    if ((!productPrice || productPrice === 0) && productsCache.has(productId)) {
                        const cachedProduct = productsCache.get(productId);
                        if (cachedProduct && cachedProduct.salePrice && cachedProduct.salePrice > 0) {
                            productPrice = cachedProduct.salePrice;
                        }
                    }
                    
                    // Prioridad 3: Precio en productInfo (ya cargado)
                    if ((!productPrice || productPrice === 0) && productInfo.salePrice && productInfo.salePrice > 0) {
                        productPrice = productInfo.salePrice;
                    }
                    
                    // Si a칰n no hay precio, intentar buscar directamente en la colecci칩n
                    if ((!productPrice || productPrice === 0) && order.collectionId) {
                        try {
                            const collectionDoc = await db.collection('collections').doc(order.collectionId).get();
                            if (collectionDoc.exists) {
                                const collectionData = collectionDoc.data();
                                const collectionProducts = collectionData.products || {};
                                const collectionProduct = collectionProducts[productId];
                                if (collectionProduct) {
                                    productPrice = collectionProduct.salePrice || collectionProduct.price || 0;
                                    // Actualizar cache para futuros usos
                                    if (productPrice > 0) {
                                        if (!productsCache.has(productId)) {
                                            productsCache.set(productId, {
                                                name: productName,
                                                imageUrl: productImageUrl,
                                                salePrice: productPrice
                                            });
                                        } else {
                                            const cached = productsCache.get(productId);
                                            cached.salePrice = productPrice;
                                            productsCache.set(productId, cached);
                                        }
                                    }
                                }
                            }
                        } catch (error) {
                            logDebug(`   丘멆잺 Error buscando producto en colecci칩n: ${error.message}`, 'warn');
                        }
                    }
                    
                    // Log para debug
                    if (!productPrice || productPrice === 0) {
                        logDebug(`   丘멆잺 Producto ${productId.substring(0, 8)} "${productName}" no tiene precio en ninguna fuente`, 'warn');
                        logDebug(`      item.salePrice: ${item.salePrice}, item.price: ${item.price}`, 'warn');
                        logDebug(`      productInfo.salePrice: ${productInfo.salePrice}`, 'warn');
                        logDebug(`      cache: ${productsCache.has(productId) ? productsCache.get(productId).salePrice : 'no existe'}`, 'warn');
                    } else {
                        logDebug(`   九 Precio encontrado para "${productName}": ${formatCurrency(productPrice)}`, 'info');
                    }
                    
                    const itemTotal = quantity * productPrice;
                    
                    const notes = item.notes ? `<div class="order-item-note" style="margin-top: 4px; font-size: 11px; color: #999;">游닇 ${item.notes}</div>` : '';
                    const rating = item.rating ? `<div class="order-item-rating" style="margin-top: 4px; font-size: 11px; color: #ffa500;">救 ${item.rating}/5</div>` : '';
                    
                    const imageHtml = productImageUrl 
                        ? `<img src="${productImageUrl}" alt="${productName}" class="order-item-image" onerror="this.style.display='none'">`
                        : `<div class="order-item-image" style="display: flex; align-items: center; justify-content: center; color: #999; font-size: 24px;">游닍</div>`;
                    
                    return {
                        html: `
                            <div class="order-item">
                                ${imageHtml}
                                <div class="order-item-info" style="flex: 1;">
                                    <div class="order-item-name">${productName}</div>
                                    <div class="order-item-details">
                                        <div style="margin-bottom: 2px;">
                                            <strong>Cantidad:</strong> ${quantity} 칑 ${formatCurrency(productPrice)} = <strong>${formatCurrency(itemTotal)}</strong>
                                        </div>
                                        ${notes}
                                        ${rating}
                                    </div>
                                </div>
                                <div class="order-item-price" style="font-size: 16px; font-weight: 700; color: #009FE3;">
                                    ${formatCurrency(itemTotal)}
                                </div>
                            </div>
                        `,
                        itemTotal: itemTotal,
                        quantity: quantity,
                        productPrice: productPrice
                    };
                }));

                // Calcular totales desde los items procesados
                let calculatedTotal = 0;
                let calculatedItemCount = 0;
                const itemsHtmlArray = itemsData.map(itemData => {
                    calculatedTotal += itemData.itemTotal;
                    calculatedItemCount += itemData.quantity;
                    return itemData.html;
                });

                // Usar total calculado o el del pedido (el calculado tiene prioridad)
                const total = calculatedTotal > 0 ? calculatedTotal : (order.subtotal || 0);
                const itemCount = calculatedItemCount > 0 ? calculatedItemCount : (order.itemCount || 0);
                
                logDebug(`   游눯 Total calculado para pedido #${orderNumber}: ${formatCurrency(total)} (${itemCount} items)`, 'info');

                // Determinar si el pedido estaba expandido
                const wasExpanded = expandedOrders.has(index);
                const expandedClass = wasExpanded ? 'expanded' : '';
                const expandBtnText = wasExpanded ? 'Ocultar detalles 郊' : 'Ver detalles de productos 郊';

                return `
                    <div class="order-card ${isPending ? 'pending-highlight' : ''} ${expandedClass}" id="order-${index}">
                        <div class="order-header">
                            <div>
                                <h3>Pedido #${orderNumber}</h3>
                                ${isPending ? '<span class="notification-badge">!</span>' : ''}
                            </div>
                            <span class="order-status ${status.class}">${status.text}</span>
                        </div>
                        <p><strong>Colecci칩n:</strong> ${order.collectionName || 'N/A'}</p>
                        <div class="order-details">
                            <div class="order-detail-item">
                                <label>Fecha</label>
                                <span>${formatDate(order.createdAt)}</span>
                            </div>
                            <div class="order-detail-item">
                                <label>Items</label>
                                <span>${itemCount} producto${itemCount !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="order-detail-item" style="font-weight: 700; font-size: 16px; color: #009FE3;">
                                <label>Total del Pedido</label>
                                <span>${formatCurrency(total)}</span>
                            </div>
                            <div class="order-detail-item">
                                <label>M칠todo de Pago</label>
                                <span>${order.paymentMethod || 'N/A'}</span>
                            </div>
                        </div>
                        ${itemsHtmlArray.length > 0 ? `
                            <button class="expand-btn" onclick="toggleOrderDetails(${index})">
                                ${expandBtnText}
                            </button>
                            <div class="order-items">
                                <h4 class="order-items-title" style="margin-bottom: 12px; color: #333; font-size: 16px;">游닍 Productos del pedido:</h4>
                                <div class="order-items-list" style="border-top: 1px solid #eee; padding-top: 12px; margin-bottom: 12px;">
                                    ${itemsHtmlArray.join('')}
                                </div>
                                <div class="order-items-total" style="border-top: 2px solid #009FE3; padding-top: 12px; margin-top: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 700; color: #009FE3;">
                                    <span>Total del Pedido:</span>
                                    <span>${formatCurrency(total)}</span>
                                </div>
                            </div>
                        ` : ''}
                        ${order.observations ? `
                            <div class="order-observations" style="margin-top: 15px; padding: 12px; background: #f0f0f0; border-radius: 8px;">
                                <strong>Observaciones:</strong> ${order.observations}
                            </div>
                        ` : ''}
                    </div>
                `;
            }));

            container.innerHTML = ordersHtml.join('');
        }

        // Funci칩n para expandir/colapsar detalles del pedido
        function toggleOrderDetails(index) {
            const orderCard = document.getElementById(`order-${index}`);
            const btn = orderCard.querySelector('.expand-btn');
            
            if (orderCard.classList.contains('expanded')) {
                orderCard.classList.remove('expanded');
                btn.textContent = 'Ver detalles de productos 郊';
            } else {
                orderCard.classList.add('expanded');
                btn.textContent = 'Ocultar detalles 郊';
            }
        }

        // Funci칩n para actualizar estad칤sticas
        function updateStats() {
            try {
                const collectionsCount = collections.length;
                const ordersCount = orders.length;
                const pendingCount = orders.filter(o => {
                    const status = o.status || 'APPROVED';
                    return status === 'APPROVED' || status === 'IN_PRODUCTION' || status === 'READY_FOR_DELIVERY';
                }).length;
                // Calcular valor total sumando todos los items de todos los pedidos
                let totalValue = 0;
                orders.forEach(order => {
                    const items = order.items || {};
                    let orderTotal = 0;
                    
                    // Calcular total del pedido desde los items
                    Object.entries(items).forEach(([productId, item]) => {
                        const quantity = item.quantity || 0;
                        // Buscar precio: primero en el item, luego en el cache de productos
                        let price = item.salePrice || item.price || 0;
                        if (!price || price === 0) {
                            const cachedProduct = productsCache.get(productId);
                            if (cachedProduct) {
                                price = cachedProduct.salePrice || 0;
                            }
                        }
                        orderTotal += quantity * price;
                    });
                    
                    // Si no hay items o el total calculado es 0, usar el subtotal del pedido
                    if (orderTotal === 0) {
                        orderTotal = order.subtotal || 0;
                    }
                    
                    totalValue += typeof orderTotal === 'number' ? orderTotal : parseFloat(orderTotal) || 0;
                });
                
                const statCollectionsEl = document.getElementById('stat-collections');
                const statOrdersEl = document.getElementById('stat-orders');
                const statPendingEl = document.getElementById('stat-pending');
                const statTotalEl = document.getElementById('stat-total');
                
                if (statCollectionsEl) {
                    statCollectionsEl.textContent = collectionsCount;
                    logDebug(`   游늵 Colecciones: ${collectionsCount}`, 'info');
                }
                if (statOrdersEl) {
                    statOrdersEl.textContent = ordersCount;
                    logDebug(`   游늵 Pedidos totales: ${ordersCount}`, 'info');
                }
                if (statPendingEl) {
                    statPendingEl.textContent = pendingCount;
                    logDebug(`   游늵 Pedidos pendientes: ${pendingCount}`, 'info');
                }
                if (statTotalEl) {
                    statTotalEl.textContent = formatCurrency(totalValue);
                    logDebug(`   游늵 Valor total: ${formatCurrency(totalValue)}`, 'info');
                }
                
                logDebug(`游늵 Estad칤sticas actualizadas: ${collectionsCount} colecciones, ${ordersCount} pedidos, ${pendingCount} pendientes, ${formatCurrency(totalValue)} total`, 'info');
            } catch (error) {
                logDebug(`丘멆잺 Error actualizando estad칤sticas: ${error.message}`, 'error');
                logDebug(`   Stack: ${error.stack}`, 'error');
            }
        }

        // Funci칩n para mostrar error
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Funci칩n principal de inicializaci칩n
        async function init() {
            logDebug('游 Iniciando portal del cliente...', 'info');
            
            if (!token) {
                logDebug('仇 No se proporcion칩 token en la URL', 'error');
                showError('Token de acceso no proporcionado. Por favor, usa el enlace que te envi칩 el negocio.');
                return;
            }

            logDebug(`游댐 Token recibido: ${token}`, 'info');

            try {
                // Verificar que Firebase est칠 inicializado
                logDebug('游댠 Verificando conexi칩n con Firebase...', 'info');
                if (!firebase.apps || firebase.apps.length === 0) {
                    logDebug('仇 Firebase no est치 inicializado', 'error');
                    throw new Error('Error de conexi칩n con Firebase');
                }
                if (!db) {
                    logDebug('仇 Firestore no est치 disponible', 'error');
                    throw new Error('Error de conexi칩n con Firestore');
                }
                logDebug('九 Firebase y Firestore inicializados correctamente', 'info');
                
                // Buscar cliente por token
                logDebug('游댌 Iniciando b칰squeda del cliente...', 'info');
                await findCustomerByToken();
                
                if (!customerId) {
                    logDebug('仇 No se pudo encontrar el customerId despu칠s de la b칰squeda', 'error');
                    showError('No se pudo encontrar tu informaci칩n. Verifica que el token sea correcto.');
                    return;
                }

                logDebug(`九 Portal inicializado correctamente para cliente: ${customerId}`, 'info');
                
                // Verificar que customerData tenga el nombre
                if (customerData) {
                    logDebug(`游늶 Datos del cliente cargados:`, 'info');
                    logDebug(`   - ID: ${customerData.id || customerId}`, 'info');
                    logDebug(`   - Nombre: ${customerData.name || 'NO DISPONIBLE'}`, 'info');
                    logDebug(`   - Email: ${customerData.email || 'NO DISPONIBLE'}`, 'info');
                    logDebug(`   - Tel칠fono: ${customerData.phone || 'NO DISPONIBLE'}`, 'info');
                    logDebug(`   - Template preferido: ${customerData.preferredTemplate || 'NO DEFINIDO (usar치 el m치s com칰n de colecciones)'}`, 'info');
                }

                // Ocultar loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('portal-content').style.display = 'block';
                
                // Limpiar localStorage del template para evitar conflictos
                // El template se determinar치 desde Firestore cuando se carguen las colecciones
                try {
                    localStorage.removeItem('portalTemplate');
                    logDebug(`游딈勇 Template de localStorage limpiado para evitar conflictos`, 'info');
                } catch (e) {
                    logDebug(`丘멆잺 No se pudo limpiar localStorage: ${e.message}`, 'warn');
                }
                logDebug(`游꿛 Esperando template desde Firestore (no usando localStorage)`, 'info');

                // Actualizar saludo temporal (primera vez)
                updateTemporalGreeting();

                // Mostrar footer
                showAppFooter();

                // Cargar datos
                logDebug('游닍 Cargando colecciones y pedidos...', 'info');
                await Promise.all([
                    loadCollections(),
                    loadOrders()
                ]);
                
                // Actualizar saludo nuevamente despu칠s de cargar datos (por si customerData se actualiz칩)
                updateTemporalGreeting();
                
                logDebug('九 Portal cargado completamente', 'info');

                // 九 Inicializar chat
                initChat();

                // 九 Configurar actualizaci칩n autom치tica de pedidos cada 30 segundos
                setInterval(async () => {
                    logDebug('游댃 Actualizando pedidos autom치ticamente...', 'info');
                    await loadOrders();
                    await loadCollections(); // Re-cargar colecciones para actualizar estados
                    updateStats(); // Actualizar estad칤sticas
                }, 30000); // 30 segundos

            } catch (error) {
                logDebug(`仇 ERROR CR칈TICO: ${error.message}`, 'error');
                logDebug(`   Tipo: ${error.name}`, 'error');
                logDebug(`   Stack: ${error.stack}`, 'error');
                const errorMessage = error.message || 'Error al cargar el portal. Por favor, intenta m치s tarde.';
                showError(errorMessage);
            }
        }

        // 九 Variables globales para el chat (ahora centralizado por cliente)
        let chatListener = null;
        let unreadCount = 0;

        // 九 Funci칩n para abrir chat del cliente (centralizado)
        function openChat() {
            if (!customerId) {
                alert('No se pudo identificar el cliente');
                return;
            }
            
            const chatFab = document.getElementById('chatFab');
            const chatPanel = document.getElementById('chatFloatingPanel');
            const chatCollectionName = document.getElementById('chatCollectionName');
            
            if (chatCollectionName) {
                chatCollectionName.textContent = `Chat - ${customerData?.name || 'Cliente'}`;
            }
            
            if (chatFab) chatFab.style.display = 'flex';
            if (chatPanel) chatPanel.style.display = 'flex';
            
            loadChatMessages();
        }

        // 九 Funci칩n para cargar mensajes del chat del cliente (centralizado)
        function loadChatMessages() {
            if (!customerId) return;
            
            // Limpiar listener anterior
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            
            const messagesDiv = document.getElementById('chatMessagesFloating');
            if (!messagesDiv) return;
            
            messagesDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Cargando mensajes...</p>';
            
            // Usar chat centralizado del cliente: customers/{customerId}/messages
            // Filtrar por collectionId si hay una colecci칩n activa (opcional, para mostrar solo mensajes relevantes)
            const messagesRef = db.collection(`customers/${customerId}/messages`);
            let q = messagesRef.orderBy('timestamp', 'asc').limit(100);
            
            // Opcional: filtrar por collectionId si hay una colecci칩n activa
            // Comentado para mostrar todos los mensajes del cliente (chat centralizado)
            // if (currentCollectionId) {
            //     q = messagesRef.where('collectionId', '==', currentCollectionId).orderBy('timestamp', 'asc').limit(100);
            // }
            
            chatListener = q.onSnapshot((snapshot) => {
                if (!messagesDiv) return;
                
                messagesDiv.innerHTML = '';
                
                if (snapshot.empty) {
                    messagesDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay mensajes a칰n. 춰Inicia la conversaci칩n!</p>';
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isBusiness = msg.senderType === 'BUSINESS';
                    
                    const wrapperDiv = document.createElement('div');
                    wrapperDiv.className = `message-wrapper ${isBusiness ? 'business' : 'client'}`;
                    
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message ${isBusiness ? 'business' : 'client'}`;
                    
                    let authorHtml = '';
                    if (!isBusiness && msg.senderName) {
                        authorHtml = `<div class="message-author">${msg.senderName}</div>`;
                    }
                    
                    msgDiv.innerHTML = `
                        ${authorHtml}
                        <div class="message-content">${msg.message || ''}</div>
                    `;
                    
                    wrapperDiv.appendChild(msgDiv);
                    messagesDiv.appendChild(wrapperDiv);
                });
                
                // Scroll al final
                setTimeout(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 50);
                
                // Actualizar badge si hay mensajes nuevos del negocio y el panel est치 cerrado
                const chatPanel = document.getElementById('chatFloatingPanel');
                if (chatPanel && chatPanel.style.display !== 'flex') {
                    const lastMsg = snapshot.docs[snapshot.docs.length - 1];
                    if (lastMsg && lastMsg.data().senderType === 'BUSINESS') {
                        unreadCount++;
                        const badge = document.getElementById('chatFabBadge');
                        if (badge) {
                            badge.textContent = String(unreadCount);
                            badge.style.display = 'flex';
                        }
                    }
                }
            }, (error) => {
                console.error('Error cargando mensajes:', error);
                if (messagesDiv) {
                    messagesDiv.innerHTML = '<p style="text-align: center; color: #f44336; padding: 20px;">Error al cargar mensajes.</p>';
                }
            });
        }

        // 九 Funci칩n para enviar mensaje (chat centralizado del cliente)
        async function sendChatMessage() {
            if (!customerId) {
                alert('No se pudo identificar el cliente');
                return;
            }
            
            const input = document.getElementById('chatInputFloating');
            const message = input?.value?.trim();
            if (!message) return;
            
            try {
                // Usar chat centralizado del cliente: customers/{customerId}/messages
                const messagesRef = db.collection(`customers/${customerId}/messages`);
                await messagesRef.add({
                    collectionId: currentCollectionId || null, // Agregar collectionId si hay una colecci칩n activa
                    senderType: 'CLIENT',
                    senderId: customerId,
                    senderName: customerData?.name || 'Cliente',
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false,
                    attachments: []
                });
                
                input.value = '';
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                alert('Error al enviar el mensaje');
            }
        }

        // 九 Funci칩n para toggle del chat flotante (chat centralizado del cliente)
        function toggleFloatingChat(open) {
            const chatPanel = document.getElementById('chatFloatingPanel');
            if (!chatPanel) return;
            
            const show = open !== undefined ? open : (chatPanel.style.display !== 'flex');
            chatPanel.style.display = show ? 'flex' : 'none';
            
            if (show && customerId) {
                unreadCount = 0;
                const badge = document.getElementById('chatFabBadge');
                if (badge) badge.style.display = 'none';
                
                // Cargar mensajes del chat del cliente
                loadChatMessages();
            }
        }

        // 九 Inicializar eventos del chat
        function initChat() {
            const chatFab = document.getElementById('chatFab');
            const chatClose = document.getElementById('chatFloatingClose');
            const sendBtn = document.getElementById('sendMessageFloating');
            const chatInput = document.getElementById('chatInputFloating');
            
            if (chatFab) {
                chatFab.addEventListener('click', () => toggleFloatingChat());
            }
            
            if (chatClose) {
                chatClose.addEventListener('click', () => toggleFloatingChat(false));
            }
            
            if (sendBtn) {
                sendBtn.addEventListener('click', sendChatMessage);
            }
            
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
            
            // Mostrar bot칩n de chat siempre que haya customerId (chat centralizado)
            if (customerId && chatFab) {
                chatFab.style.display = 'flex';
            }
        }

        // Funci칩n para mostrar vista del portal
        async function showPortalView() {
            const portalContent = document.getElementById('portal-content');
            const collectionView = document.getElementById('collection-view');
            const breadcrumbs = document.getElementById('breadcrumbs');
            const tipsSection = document.getElementById('tips-section');
            const appFooter = document.getElementById('app-footer');
            const collectionsSection = document.querySelector('.collections-section');
            
            // Asegurar que el template global se mantenga aplicado
            // Esto garantiza consistencia visual en toda la navegaci칩n
            applyTemplate(globalTemplate);
            logDebug(`游꿛 Template global reaplicado al volver al portal: ${globalTemplate}`, 'info');
            
            if (collectionView) {
                collectionView.classList.remove('active');
                collectionView.style.display = 'none';
            }
            
            if (breadcrumbs) {
                breadcrumbs.style.display = 'none';
            }
            
            if (portalContent) {
                portalContent.style.display = 'block';
            }
            
            // Mostrar secci칩n de colecciones si estaba oculta
            if (collectionsSection) {
                collectionsSection.style.display = 'block';
            }
            
            // Limpiar datos de la colecci칩n
            currentCollectionId = null;
            currentCollectionData = null;
            collectionProducts = [];
            selectedItems = {};
            
            // Recargar colecciones desde Firestore para asegurar datos actualizados
            logDebug('游댃 Recargando colecciones al volver al home...', 'info');
            await loadCollections();
            
            // Activar la pesta침a de colecciones por defecto (despu칠s de cargar)
            switchTab(null, 'collections');
            
            // Activar el bot칩n de colecciones
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const collectionsTab = document.querySelector('.tab');
            if (collectionsTab) {
                collectionsTab.classList.add('active');
            }
            
            if (tipsSection) {
                tipsSection.style.display = 'block';
            }
            
            if (appFooter) {
                appFooter.style.display = 'block';
            }
            
            logDebug('游 Vista del portal mostrada y colecciones recargadas', 'info');
        }

        // Funci칩n para mostrar vista de colecci칩n
        async function showCollectionView(collectionId) {
            const portalContent = document.getElementById('portal-content');
            const collectionView = document.getElementById('collection-view');
            const breadcrumbs = document.getElementById('breadcrumbs');
            const collectionsSection = document.querySelector('.collections-section');
            const tipsSection = document.getElementById('tips-section');
            const appFooter = document.getElementById('app-footer');
            
            if (!collectionId) {
                logDebug('仇 No se proporcion칩 collectionId', 'error');
                return;
            }
            
            logDebug(`游닄 Navegando a colecci칩n: ${collectionId}`, 'info');
            
            // Asegurar que el template global se mantenga aplicado
            // Esto garantiza consistencia visual en toda la navegaci칩n
            applyTemplate(globalTemplate);
            logDebug(`游꿛 Template global reaplicado al navegar a colecci칩n: ${globalTemplate}`, 'info');
            
            // Ocultar secciones del portal
            if (collectionsSection) {
                collectionsSection.style.display = 'none';
            }
            
            if (tipsSection) {
                tipsSection.style.display = 'none';
            }
            
            if (appFooter) {
                appFooter.style.display = 'none';
            }
            
            // Ocultar portal content pero mantenerlo en el DOM para que los estilos del template se apliquen
            if (portalContent) {
                portalContent.style.display = 'none';
            }
            
            // Mostrar breadcrumbs
            if (breadcrumbs) {
                breadcrumbs.style.display = 'flex';
            }
            
            // Mostrar vista de colecci칩n
            if (collectionView) {
                collectionView.classList.add('active');
                collectionView.style.display = 'block';
                collectionView.style.visibility = 'visible';
                collectionView.style.opacity = '1';
                collectionView.style.position = 'relative';
                collectionView.style.zIndex = '1';
                
                // Verificar visibilidad despu칠s de aplicar estilos
                setTimeout(() => {
                    const computedStyle = window.getComputedStyle(collectionView);
                    logDebug(`游댌 Verificaci칩n de collection-view:`, 'info');
                    logDebug(`   - display: ${computedStyle.display}`, 'info');
                    logDebug(`   - visibility: ${computedStyle.visibility}`, 'info');
                    logDebug(`   - opacity: ${computedStyle.opacity}`, 'info');
                    logDebug(`   - position: ${computedStyle.position}`, 'info');
                    logDebug(`   - z-index: ${computedStyle.zIndex}`, 'info');
                    logDebug(`   - width: ${computedStyle.width}`, 'info');
                    logDebug(`   - height: ${computedStyle.height}`, 'info');
                    logDebug(`   - tiene clase 'active': ${collectionView.classList.contains('active')}`, 'info');
                    
                    if (computedStyle.display === 'none') {
                        logDebug(`丘멆잺 ADVERTENCIA: collection-view tiene display: none despu칠s de aplicar estilos!`, 'error');
                        // Forzar visibilidad
                        collectionView.style.setProperty('display', 'block', 'important');
                    }
                }, 100);
            } else {
                logDebug(`仇 collection-view no encontrado en el DOM`, 'error');
            }
            
            // Actualizar breadcrumb
            const collection = collections.find(c => c.id === collectionId);
            if (collection && breadcrumbs) {
                const breadcrumbName = document.getElementById('breadcrumb-collection-name');
                if (breadcrumbName) {
                    breadcrumbName.textContent = collection.name || 'Colecci칩n';
                }
            }
            
            // Cargar datos de la colecci칩n
            await loadCollectionData(collectionId);
            
            logDebug(`九 Vista de colecci칩n mostrada: ${collectionId}`, 'info');
        }

        // Funci칩n para cargar datos de la colecci칩n
        async function loadCollectionData(collectionId) {
            try {
                logDebug(`游닍 Cargando datos de la colecci칩n: ${collectionId}`, 'info');
                
                const collectionDoc = await db.collection('collections').doc(collectionId).get();
                
                if (!collectionDoc.exists) {
                    throw new Error('Colecci칩n no encontrada');
                }
                
                currentCollectionData = collectionDoc.data();
                currentCollectionId = collectionId;
                
                // Actualizar header de la vista
                const collectionNameEl = document.getElementById('collection-view-name');
                const collectionDescEl = document.getElementById('collection-view-description');
                
                if (collectionNameEl) {
                    collectionNameEl.textContent = currentCollectionData.name || 'Colecci칩n';
                }
                
                if (collectionDescEl) {
                    collectionDescEl.textContent = currentCollectionData.description || 'Sin descripci칩n';
                }
                
                // Cargar productos
                await loadCollectionProducts(collectionId);
                
            } catch (error) {
                logDebug(`仇 Error cargando colecci칩n: ${error.message}`, 'error');
                const container = document.getElementById('collection-products-container');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>Error al cargar la colecci칩n</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // Funci칩n para cargar productos de la colecci칩n
        async function loadCollectionProducts(collectionId) {
            try {
                logDebug(`游띐勇 Cargando productos de la colecci칩n: ${collectionId}`, 'info');
                
                const container = document.getElementById('collection-products-container');
                if (!container) return;
                
                container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Cargando productos...</p></div>';
                
                // Intentar cargar desde subcolecci칩n items
                let items = [];
                try {
                    const itemsSnapshot = await db.collection(`collections/${collectionId}/items`).get();
                    items = itemsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        productId: doc.id,
                        ...doc.data()
                    }));
                    logDebug(`   九 Productos encontrados en subcolecci칩n: ${items.length}`, 'info');
                } catch (e) {
                    logDebug(`   丘멆잺 No se encontr칩 subcolecci칩n items, intentando otra forma...`, 'warn');
                }
                
                // Si no hay items en subcolecci칩n, cargar desde el documento
                if (items.length === 0 && currentCollectionData) {
                    const data = currentCollectionData;
                    if (data.items && Array.isArray(data.items)) {
                        items = data.items.map((item, index) => ({
                            productId: item.productId || item.id || `item_${index}`,
                            ...item
                        }));
                    } else if (data.items && typeof data.items === 'object') {
                        items = Object.entries(data.items).map(([productId, itemData]) => {
                            const item = itemData || {};
                            return {
                                productId,
                                id: productId,
                                ...item,
                                ...(item.productId ? {} : { productId })
                            };
                        });
                    }
                    logDebug(`   九 Productos encontrados en documento: ${items.length}`, 'info');
                }
                
                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No hay productos disponibles</h3>
                            <p>Esta colecci칩n no tiene productos todav칤a.</p>
                        </div>
                    `;
                    return;
                }
                
                // Cargar informaci칩n completa de productos
                collectionProducts = [];
                const productsCache = new Map();
                
                for (const item of items) {
                    const productId = item.productId || item.id;
                    if (!productId) continue;
                    
                    let productInfo = null;
                    
                    // Intentar obtener desde cache
                    if (productsCache.has(productId)) {
                        productInfo = productsCache.get(productId);
                    } else {
                        // Intentar cargar desde colecci칩n products
                        try {
                            const productDoc = await db.collection('products').doc(productId).get();
                            if (productDoc.exists) {
                                productInfo = { id: productDoc.id, ...productDoc.data() };
                                productsCache.set(productId, productInfo);
                            }
                        } catch (e) {
                            logDebug(`   丘멆잺 No se pudo cargar producto ${productId}: ${e.message}`, 'warn');
                        }
                    }
                    
                    // Combinar datos del item con datos del producto
                    // Buscar imagen en m칰ltiples campos posibles (prioridad: productInfo primero, luego item)
                    let imageUrl = null;
                    
                    // Buscar en productInfo primero (datos completos del producto)
                    if (productInfo) {
                        imageUrl = productInfo.imageUrl || 
                                  productInfo.photoUrl || 
                                  productInfo.thumbnailUrl || 
                                  productInfo.image || 
                                  productInfo.photo ||
                                  productInfo.imageBackupUrl ||
                                  null;
                    }
                    
                    // Si no se encontr칩 en productInfo, buscar en item (datos del item en la colecci칩n)
                    if (!imageUrl && item) {
                        imageUrl = item.imageUrl || 
                                  item.photoUrl || 
                                  item.thumbnailUrl || 
                                  item.image || 
                                  item.photo ||
                                  item.imageBackupUrl ||
                                  null;
                    }
                    
                    const finalProduct = {
                        id: productId,
                        name: productInfo?.name || item.name || 'Producto sin nombre',
                        description: productInfo?.description || item.description || '',
                        imageUrl: imageUrl,
                        salePrice: item.salePrice || productInfo?.salePrice || item.price || 0,
                        stockQuantity: item.stockQuantity !== undefined ? item.stockQuantity : (productInfo?.stockQuantity || 0),
                        notes: item.notes || productInfo?.notes || '',
                        isFeatured: item.isFeatured || false
                    };
                    
                    // Log detallado para debug
                    logDebug(`   游댌 Analizando producto: ${productId} (${finalProduct.name})`, 'info');
                    if (productInfo) {
                        logDebug(`      游닍 productInfo campos: ${Object.keys(productInfo).join(', ')}`, 'info');
                        logDebug(`      游닍 productInfo.imageUrl: ${productInfo.imageUrl || 'null'}`, 'info');
                        logDebug(`      游닍 productInfo.photoUrl: ${productInfo.photoUrl || 'null'}`, 'info');
                        logDebug(`      游닍 productInfo.thumbnailUrl: ${productInfo.thumbnailUrl || 'null'}`, 'info');
                    } else {
                        logDebug(`      丘멆잺 productInfo no disponible`, 'warn');
                    }
                    logDebug(`      游늶 item campos: ${Object.keys(item).join(', ')}`, 'info');
                    logDebug(`      游늶 item.imageUrl: ${item.imageUrl || 'null'}`, 'info');
                    logDebug(`      游늶 item.photoUrl: ${item.photoUrl || 'null'}`, 'info');
                    logDebug(`      游늶 item.thumbnailUrl: ${item.thumbnailUrl || 'null'}`, 'info');
                    
                    if (!imageUrl) {
                        logDebug(`   仇 Producto ${productId} (${finalProduct.name}) NO tiene imagen`, 'error');
                    } else {
                        logDebug(`   九 Producto ${productId} (${finalProduct.name}) tiene imagen: ${imageUrl.substring(0, 60)}...`, 'info');
                    }
                    
                    collectionProducts.push(finalProduct);
                    
                    // Inicializar selectedItems si no existe
                    if (!selectedItems[productId]) {
                        selectedItems[productId] = {
                            quantity: 0,
                            notes: '',
                            rating: null
                        };
                    }
                }
                
                logDebug(`   九 Total productos cargados: ${collectionProducts.length}`, 'info');
                
                // Renderizar productos
                renderCollectionProducts();
                
            } catch (error) {
                logDebug(`仇 Error cargando productos: ${error.message}`, 'error');
                const container = document.getElementById('collection-products-container');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>Error al cargar productos</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // Funci칩n para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Funci칩n para renderizar productos
        function renderCollectionProducts() {
            const container = document.getElementById('collection-products-container');
            if (!container) {
                logDebug(`仇 No se puede renderizar productos: el contenedor no existe`, 'error');
                return;
            }
            
            // Verificar visibilidad del contenedor
            const containerStyle = window.getComputedStyle(container);
            const isVisible = containerStyle.display !== 'none' && containerStyle.visibility !== 'hidden';
            logDebug(`游댌 Contenedor de productos - visible: ${isVisible}, display: ${containerStyle.display}, visibility: ${containerStyle.visibility}`, 'info');
            
            if (collectionProducts.length === 0) {
                logDebug(`丘멆잺 No hay productos para renderizar`, 'warn');
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay productos disponibles</h3>
                        <p>Esta colecci칩n no tiene productos todav칤a.</p>
                    </div>
                `;
                return;
            }
            
            logDebug(`游꿛 Renderizando ${collectionProducts.length} productos`, 'info');
            logDebug(`   游닍 Productos a renderizar:`, 'info');
            collectionProducts.forEach((p, idx) => {
                logDebug(`      [${idx}] ${p.name} - Precio: $${p.salePrice} - Imagen: ${p.imageUrl ? 'S칈' : 'NO'}`, 'info');
            });
            
            // Crear el HTML de manera segura
            const productsHTML = collectionProducts.map(product => {
                const escapedId = escapeHtml(product.id);
                const escapedName = escapeHtml(product.name);
                const escapedDescription = product.description ? escapeHtml(product.description) : '';
                const escapedNotes = product.notes ? escapeHtml(product.notes) : '';
                const escapedImageUrl = product.imageUrl ? escapeHtml(product.imageUrl) : '';
                const quantity = selectedItems[product.id]?.quantity || 0;
                const itemNotes = selectedItems[product.id]?.notes || '';
                const escapedItemNotes = escapeHtml(itemNotes);
                
                logDebug(`   游뒆勇 Renderizando producto: ${product.name}, imagen: ${product.imageUrl ? 'S칈' : 'NO'}`, 'info');
                
                return `
                    <div class="product-card">
                        <div class="product-image-container">
                            ${product.imageUrl ? 
                                `<img src="${escapedImageUrl}" alt="${escapedName}" loading="lazy" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<span style=\\'color: #999;\\'>Error cargando imagen</span>';">` :
                                `<span style="color: #999;">Sin imagen</span>`
                            }
                        </div>
                        <h3>${escapedName}</h3>
                        ${escapedDescription ? `<p class="product-description">${escapedDescription}</p>` : ''}
                        ${escapedNotes ? `<p style="color: #009FE3; font-size: 0.85em; margin: 5px 0; font-style: italic;">${escapedNotes}</p>` : ''}
                        <p class="product-price">$${product.salePrice.toLocaleString('es-CL')}</p>
                        ${product.stockQuantity <= 0 ? 
                            `<p style="color: #f87171; font-size: 0.85em; margin: 5px 0;">丘멆잺 Sin stock</p>` : 
                            `<p style="color: #4CAF50; font-size: 0.85em; margin: 5px 0;">九 Disponible</p>`
                        }
                        <div class="quantity-control">
                            <button onclick="updateProductQuantity('${escapedId}', -1)" ${product.stockQuantity <= 0 ? 'disabled' : ''}>-</button>
                            <span id="qty-${escapedId}">${quantity}</span>
                            <button onclick="updateProductQuantity('${escapedId}', 1)" ${product.stockQuantity <= 0 ? 'disabled' : ''}>+</button>
                        </div>
                        <input 
                            type="text" 
                            class="notes-input" 
                            placeholder="Notas adicionales (opcional)..." 
                            value="${escapedItemNotes}"
                            onchange="updateProductNotes('${escapedId}', this.value)"
                        />
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="products-grid">${productsHTML}</div>`;
            
            // Forzar visibilidad del contenedor y del grid
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';
            
            const productsGrid = container.querySelector('.products-grid');
            if (productsGrid) {
                productsGrid.style.display = 'grid';
                productsGrid.style.visibility = 'visible';
                productsGrid.style.opacity = '1';
            }
            
            // Verificar que el HTML se insert칩 correctamente
            const htmlLength = container.innerHTML.length;
            const productCards = container.querySelectorAll('.product-card');
            
            logDebug(`九 Productos renderizados en el DOM`, 'info');
            logDebug(`   - HTML insertado: ${htmlLength} caracteres`, 'info');
            logDebug(`   - Tarjetas de productos encontradas: ${productCards.length}`, 'info');
            logDebug(`   - Grid de productos encontrado: ${productsGrid ? 'S칈' : 'NO'}`, 'info');
            
            // Verificar estilos del grid
            if (productsGrid) {
                const gridStyle = window.getComputedStyle(productsGrid);
                logDebug(`   - Grid display: ${gridStyle.display}`, 'info');
                logDebug(`   - Grid grid-template-columns: ${gridStyle.gridTemplateColumns}`, 'info');
                logDebug(`   - Grid visibility: ${gridStyle.visibility}`, 'info');
                logDebug(`   - Grid opacity: ${gridStyle.opacity}`, 'info');
                logDebug(`   - Grid width: ${gridStyle.width}`, 'info');
                logDebug(`   - Grid height: ${gridStyle.height}`, 'info');
                
                if (gridStyle.display === 'none') {
                    logDebug(`丘멆잺 ADVERTENCIA: Grid tiene display: none! Forzando visibilidad...`, 'error');
                    productsGrid.style.setProperty('display', 'grid', 'important');
                }
            }
            
            // Verificar visibilidad del contenedor despu칠s de renderizar
            const finalContainerStyle = window.getComputedStyle(container);
            const finalIsVisible = finalContainerStyle.display !== 'none' && finalContainerStyle.visibility !== 'hidden';
            logDebug(`   - Contenedor visible despu칠s de renderizar: ${finalIsVisible}`, finalIsVisible ? 'info' : 'warn');
            logDebug(`   - Contenedor display: ${finalContainerStyle.display}`, 'info');
            logDebug(`   - Contenedor visibility: ${finalContainerStyle.visibility}`, 'info');
            logDebug(`   - Contenedor opacity: ${finalContainerStyle.opacity}`, 'info');
            logDebug(`   - Contenedor width: ${finalContainerStyle.width}`, 'info');
            logDebug(`   - Contenedor height: ${finalContainerStyle.height}`, 'info');
            
            // Verificar el contenedor padre (collection-view)
            const collectionView = document.getElementById('collection-view');
            if (collectionView) {
                const collectionViewStyle = window.getComputedStyle(collectionView);
                logDebug(`   - Collection-view display: ${collectionViewStyle.display}`, 'info');
                logDebug(`   - Collection-view visibility: ${collectionViewStyle.visibility}`, 'info');
                logDebug(`   - Collection-view tiene clase 'active': ${collectionView.classList.contains('active')}`, 'info');
            }
            
            if (productCards.length !== collectionProducts.length) {
                logDebug(`丘멆잺 ADVERTENCIA: Se esperaban ${collectionProducts.length} tarjetas pero se encontraron ${productCards.length} en el DOM`, 'warn');
            }
            
            // Verificar que las im치genes se cargaron
            setTimeout(() => {
                const images = container.querySelectorAll('img');
                logDebug(`   游뒆勇 Im치genes encontradas en DOM: ${images.length}`, 'info');
                images.forEach((img, index) => {
                    if (img.complete && img.naturalHeight === 0) {
                        logDebug(`   仇 Imagen ${index + 1} no se carg칩: ${img.src.substring(0, 60)}...`, 'error');
                    } else if (img.complete) {
                        logDebug(`   九 Imagen ${index + 1} cargada correctamente: ${img.width}x${img.height}px`, 'info');
                    } else {
                        logDebug(`   낍 Imagen ${index + 1} cargando...`, 'info');
                    }
                });
            }, 1000);
            
            // Mostrar resumen de pedido
            updateOrderSummary();
        }

        // Funci칩n para actualizar cantidad de producto
        function updateProductQuantity(productId, delta) {
            if (!selectedItems[productId]) {
                selectedItems[productId] = { quantity: 0, notes: '', rating: null };
            }
            
            const product = collectionProducts.find(p => p.id === productId);
            if (!product) return;
            
            const newQuantity = Math.max(0, Math.min(selectedItems[productId].quantity + delta, product.stockQuantity || 999));
            selectedItems[productId].quantity = newQuantity;
            
            // Actualizar UI
            const qtyEl = document.getElementById(`qty-${productId}`);
            if (qtyEl) {
                qtyEl.textContent = newQuantity;
            }
            
            // Actualizar resumen
            updateOrderSummary();
            
            logDebug(`游닍 Cantidad actualizada: ${productId} = ${newQuantity}`, 'info');
        }

        // Funci칩n para actualizar notas del producto
        function updateProductNotes(productId, notes) {
            if (!selectedItems[productId]) {
                selectedItems[productId] = { quantity: 0, notes: '', rating: null };
            }
            
            selectedItems[productId].notes = notes || '';
            logDebug(`游닇 Notas actualizadas: ${productId} = ${notes}`, 'info');
        }

        // Funci칩n para actualizar resumen de pedido
        function updateOrderSummary() {
            const summaryEl = document.getElementById('order-summary');
            const itemsEl = document.getElementById('order-summary-items');
            const totalEl = document.getElementById('order-summary-total');
            
            if (!summaryEl || !itemsEl || !totalEl) return;
            
            // Calcular items seleccionados
            const selectedProducts = [];
            let total = 0;
            
            Object.entries(selectedItems).forEach(([productId, item]) => {
                if (item.quantity > 0) {
                    const product = collectionProducts.find(p => p.id === productId);
                    if (product) {
                        const subtotal = item.quantity * product.salePrice;
                        total += subtotal;
                        selectedProducts.push({
                            product,
                            quantity: item.quantity,
                            notes: item.notes,
                            subtotal
                        });
                    }
                }
            });
            
            if (selectedProducts.length === 0) {
                summaryEl.style.display = 'none';
                return;
            }
            
            summaryEl.style.display = 'block';
            
            itemsEl.innerHTML = selectedProducts.map(item => `
                <div class="order-summary-item">
                    <span>${item.product.name} x${item.quantity}</span>
                    <span>$${item.subtotal.toLocaleString('es-CL')}</span>
                </div>
            `).join('');
            
            totalEl.textContent = `$${total.toLocaleString('es-CL')}`;
            
            // Pre-llenar formulario con datos del cliente si existen
            fillOrderForm();
            
            // Inicializar event listeners del formulario (solo una vez)
            if (!window.orderFormListenersInitialized) {
                initOrderFormListeners();
                window.orderFormListenersInitialized = true;
            }
        }
        
        // Pre-llenar formulario con datos del cliente
        function fillOrderForm() {
            if (!customerData) return;
            
            const nameInput = document.getElementById('order-client-name');
            const emailInput = document.getElementById('order-client-email');
            const phoneInput = document.getElementById('order-client-phone');
            const addressInput = document.getElementById('order-address');
            
            if (nameInput && customerData.name) {
                nameInput.value = customerData.name;
            }
            if (emailInput && customerData.email) {
                emailInput.value = customerData.email;
            }
            if (phoneInput && customerData.phone) {
                phoneInput.value = customerData.phone;
            }
            if (addressInput && customerData.address) {
                addressInput.value = customerData.address;
            }
        }
        
        // Validar email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Mostrar error en campo
        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            if (field) {
                field.classList.add('error');
                field.classList.remove('valid');
            }
            if (error) {
                error.textContent = message;
                error.style.display = 'block';
            }
        }
        
        // Mostrar campo v치lido
        function showFieldValid(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            if (field) {
                field.classList.remove('error');
                field.classList.add('valid');
            }
            if (error) {
                error.style.display = 'none';
            }
        }
        
        // Validar formulario de pedido
        function validateOrderForm() {
            let isValid = true;
            
            // Validar nombre
            const name = document.getElementById('order-client-name')?.value.trim();
            if (!name) {
                showFieldError('order-client-name', 'order-client-name-error', 'El nombre es requerido');
                isValid = false;
            } else {
                showFieldValid('order-client-name', 'order-client-name-error');
            }
            
            // Validar email
            const email = document.getElementById('order-client-email')?.value.trim();
            if (!email) {
                showFieldError('order-client-email', 'order-client-email-error', 'El email es requerido');
                isValid = false;
            } else if (!validateEmail(email)) {
                showFieldError('order-client-email', 'order-client-email-error', 'Ingresa un email v치lido');
                isValid = false;
            } else {
                showFieldValid('order-client-email', 'order-client-email-error');
            }
            
            // Validar tel칠fono
            const phone = document.getElementById('order-client-phone')?.value.trim();
            if (!phone) {
                showFieldError('order-client-phone', 'order-client-phone-error', 'El tel칠fono es requerido');
                isValid = false;
            } else {
                showFieldValid('order-client-phone', 'order-client-phone-error');
            }
            
            // Validar m칠todo de entrega
            const deliveryMethod = document.getElementById('order-delivery-method')?.value;
            if (!deliveryMethod) {
                showFieldError('order-delivery-method', 'order-delivery-method-error', 'Selecciona un m칠todo de entrega');
                isValid = false;
            } else {
                showFieldValid('order-delivery-method', 'order-delivery-method-error');
                
                // Validar direcci칩n si es despacho
                if (deliveryMethod === 'despacho') {
                    const address = document.getElementById('order-address')?.value.trim();
                    if (!address) {
                        showFieldError('order-address', 'order-address-error', 'La direcci칩n es requerida para despacho');
                        isValid = false;
                    } else {
                        showFieldValid('order-address', 'order-address-error');
                    }
                }
            }
            
            // Validar m칠todo de pago
            const paymentMethod = document.getElementById('order-payment-method')?.value;
            if (!paymentMethod) {
                showFieldError('order-payment-method', 'order-payment-method-error', 'Selecciona un m칠todo de pago');
                isValid = false;
            } else {
                showFieldValid('order-payment-method', 'order-payment-method-error');
            }
            
            return isValid;
        }

        // Funci칩n para enviar pedido desde el portal
        async function submitOrderFromPortal() {
            if (!currentCollectionId) {
                alert('Error: No hay colecci칩n seleccionada');
                return;
            }
            
            // Validar que hay productos seleccionados
            const hasItems = Object.values(selectedItems).some(item => item.quantity > 0);
            if (!hasItems) {
                alert('Por favor, selecciona al menos un producto');
                return;
            }
            
            // Validar formulario
            if (!validateOrderForm()) {
                // Scroll al primer error
                const firstError = document.querySelector('.form-group input.error, .form-group select.error, .form-group textarea.error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }
            
            // Preparar items del pedido
            const orderItems = {};
            let itemCount = 0;
            let subtotal = 0;
            
            Object.entries(selectedItems).forEach(([productId, item]) => {
                if (item.quantity > 0) {
                    const product = collectionProducts.find(p => p.id === productId);
                    if (product) {
                        orderItems[productId] = {
                            quantity: item.quantity,
                            notes: item.notes || null,
                            rating: item.rating || null,
                            customization: null
                        };
                        itemCount += item.quantity;
                        subtotal += item.quantity * product.salePrice;
                    }
                }
            });
            
            // Obtener valores del formulario
            const clientName = document.getElementById('order-client-name')?.value.trim() || '';
            const clientEmail = document.getElementById('order-client-email')?.value.trim() || '';
            const clientPhone = document.getElementById('order-client-phone')?.value.trim() || '';
            const deliveryMethod = document.getElementById('order-delivery-method')?.value || '';
            const address = document.getElementById('order-address')?.value.trim() || null;
            const paymentMethod = document.getElementById('order-payment-method')?.value || '';
            const observations = document.getElementById('order-observations')?.value.trim() || null;
            
            // Preparar datos del pedido
            const orderData = {
                collectionId: currentCollectionId,
                clientName: clientName,
                clientEmail: clientEmail,
                clientPhone: clientPhone,
                deliveryMethod: deliveryMethod,
                address: address,
                paymentMethod: paymentMethod,
                desiredDate: null,
                observations: observations,
                items: orderItems,
                subtotal: subtotal,
                itemCount: itemCount,
                status: 'APPROVED',
                consentToContact: true,
                customerId: customerId || null,
                accessToken: customerData?.accessToken || new URLSearchParams(window.location.search).get('token') || null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            try {
                const submitBtn = document.getElementById('submit-order-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Enviando...';
                }
                
                logDebug(`游닋 Enviando pedido para colecci칩n: ${currentCollectionId}`, 'info');
                
                const responseRef = db.collection(`collections/${currentCollectionId}/responses`);
                const docRef = await responseRef.add(orderData);
                
                logDebug(`九 Pedido enviado exitosamente: ${docRef.id}`, 'info');
                
                alert('춰Pedido enviado exitosamente! El negocio lo procesar치 pronto.');
                
                // Limpiar selecci칩n
                selectedItems = {};
                collectionProducts.forEach(product => {
                    selectedItems[product.id] = { quantity: 0, notes: '', rating: null };
                });
                
                // Limpiar formulario
                document.getElementById('order-client-name').value = '';
                document.getElementById('order-client-email').value = '';
                document.getElementById('order-client-phone').value = '';
                document.getElementById('order-delivery-method').value = '';
                document.getElementById('order-address').value = '';
                document.getElementById('order-payment-method').value = '';
                document.getElementById('order-observations').value = '';
                document.getElementById('order-address-group').style.display = 'none';
                
                // Recargar productos para actualizar UI
                await loadCollectionProducts(currentCollectionId);
                
                // Recargar pedidos en el portal
                await loadOrders();
                
            } catch (error) {
                logDebug(`仇 Error enviando pedido: ${error.message}`, 'error');
                alert('Error al enviar el pedido: ' + error.message);
                
                const submitBtn = document.getElementById('submit-order-btn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Enviar Pedido';
                }
            }
        }
        
        // Inicializar event listeners del formulario
        function initOrderFormListeners() {
            // Event listener para m칠todo de entrega (mostrar/ocultar direcci칩n)
            const deliveryMethodSelect = document.getElementById('order-delivery-method');
            const addressGroup = document.getElementById('order-address-group');
            const addressInput = document.getElementById('order-address');
            
            if (deliveryMethodSelect && addressGroup) {
                deliveryMethodSelect.addEventListener('change', function() {
                    if (this.value === 'despacho') {
                        addressGroup.style.display = 'block';
                        if (addressInput) {
                            addressInput.required = true;
                        }
                    } else {
                        addressGroup.style.display = 'none';
                        if (addressInput) {
                            addressInput.required = false;
                            addressInput.value = '';
                            // Limpiar error si existe
                            showFieldValid('order-address', 'order-address-error');
                        }
                    }
                });
            }
            
            // Validaci칩n en tiempo real de email
            const emailInput = document.getElementById('order-client-email');
            if (emailInput) {
                emailInput.addEventListener('blur', function() {
                    const email = this.value.trim();
                    if (email && !validateEmail(email)) {
                        showFieldError('order-client-email', 'order-client-email-error', 'Ingresa un email v치lido');
                    } else if (email) {
                        showFieldValid('order-client-email', 'order-client-email-error');
                    }
                });
            }
            
            // Limpiar errores al escribir
            const formInputs = ['order-client-name', 'order-client-email', 'order-client-phone', 
                               'order-delivery-method', 'order-payment-method'];
            formInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function() {
                        const errorId = inputId + '-error';
                        if (this.value.trim()) {
                            showFieldValid(inputId, errorId);
                        }
                    });
                }
            });
        }

        // Event listener para los botones de ver colecci칩n (delegaci칩n de eventos)
        document.addEventListener('click', function(e) {
            // Verificar si el clic es en el bot칩n o en un elemento hijo
            const button = e.target.closest('.view-collection-btn');
            if (button) {
                e.preventDefault();
                e.stopPropagation();
                
                const collectionId = button.getAttribute('data-collection-id');
                
                logDebug(`游댌 Click en bot칩n de colecci칩n: ${collectionId}`, 'info');
                
                if (collectionId) {
                    showCollectionView(collectionId);
                } else {
                    logDebug(`仇 No se encontr칩 collectionId en el bot칩n`, 'error');
                    alert('Error: No se pudo identificar la colecci칩n. Por favor, intenta de nuevo.');
                }
            }
        });


        // Funci칩n para obtener saludo seg칰n la hora del d칤a
        function getTemporalGreeting() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) {
                return 'Buenos d칤as';
            } else if (hour >= 12 && hour < 20) {
                return 'Buenas tardes';
            } else {
                return 'Buenas Noches';
            }
        }

        // Funci칩n para actualizar el saludo temporal
        function updateTemporalGreeting() {
            const greetingEl = document.getElementById('temporal-greeting');
            const greetingTextEl = document.getElementById('greeting-text');
            
            if (greetingEl && greetingTextEl) {
                const greeting = getTemporalGreeting();
                let text = greeting;
                
                // Intentar obtener el nombre del cliente desde customerData
                if (customerData) {
                    // Logging detallado para debugging
                    logDebug(`游댌 Buscando nombre del cliente en customerData...`, 'info');
                    logDebug(`   Campos disponibles: ${Object.keys(customerData).join(', ')}`, 'info');
                    logDebug(`   customerData.name: ${customerData.name || 'NO DEFINIDO'}`, 'info');
                    logDebug(`   customerData.companyName: ${customerData.companyName || 'NO DEFINIDO'}`, 'info');
                    
                    // Intentar obtener el nombre de diferentes formas posibles
                    let customerName = null;
                    
                    // Prioridad 1: name (campo principal)
                    if (customerData.name && typeof customerData.name === 'string' && customerData.name.trim() !== '') {
                        customerName = customerData.name.trim();
                        logDebug(`九 Nombre encontrado en customerData.name: "${customerName}"`, 'info');
                    }
                    // Prioridad 2: companyName (si no hay name)
                    else if (customerData.companyName && typeof customerData.companyName === 'string' && customerData.companyName.trim() !== '') {
                        customerName = customerData.companyName.trim();
                        logDebug(`九 Nombre encontrado en customerData.companyName: "${customerName}"`, 'info');
                    }
                    // Prioridad 3: Buscar en otros campos posibles (compatibilidad)
                    else if (customerData.businessName && typeof customerData.businessName === 'string' && customerData.businessName.trim() !== '') {
                        customerName = customerData.businessName.trim();
                        logDebug(`九 Nombre encontrado en customerData.businessName: "${customerName}"`, 'info');
                    }
                    // Prioridad 4: email como fallback (solo la parte antes del @)
                    else if (customerData.email && typeof customerData.email === 'string') {
                        const emailParts = customerData.email.split('@');
                        if (emailParts[0] && emailParts[0].trim() !== '') {
                            customerName = emailParts[0].trim();
                            logDebug(`丘멆잺 Usando parte del email como nombre: "${customerName}"`, 'warn');
                        }
                    }
                    
                    if (customerName) {
                        text += ` ${customerName}`;
                        logDebug(`九 Nombre del cliente agregado al saludo: "${customerName}"`, 'info');
                    } else {
                        logDebug(`丘멆잺 Cliente encontrado pero sin nombre disponible. ID: ${customerId}`, 'warn');
                        logDebug(`   customerData completo: ${JSON.stringify(customerData, null, 2)}`, 'warn');
                    }
                } else {
                    logDebug(`丘멆잺 customerData no est치 disponible a칰n`, 'warn');
                }
                
                greetingTextEl.textContent = text;
                greetingEl.style.display = 'block';
                logDebug(`九 Saludo temporal actualizado: "${text}"`, 'info');
            } else {
                logDebug(`丘멆잺 No se encontraron elementos del saludo temporal`, 'warn');
            }
        }

        // Funci칩n para mostrar el footer final
        function showAppFooter() {
            const appFooter = document.getElementById('app-footer');
            if (appFooter) {
                appFooter.style.display = 'block';
            }
        }

        // Inicializar cuando la p치gina carga
        window.addEventListener('DOMContentLoaded', function() {
            // Actualizar consola de debug con logs iniciales
            updateDebugConsole();
            
            // NO cargar template desde localStorage al inicio
            // El template se determinar치 desde Firestore cuando se carguen las colecciones
            // Esto evita conflictos y asegura que siempre se use el template correcto de Firestore
            logDebug(`游꿛 Inicializando sin template de localStorage - esperando Firestore`, 'info');
            
            // Inicializar event listeners del formulario (si los elementos ya est치n disponibles)
            // Tambi칠n se inicializar치n cuando se muestre el formulario por primera vez
            setTimeout(() => {
                if (document.getElementById('order-delivery-method')) {
                    initOrderFormListeners();
                    window.orderFormListenersInitialized = true;
                }
            }, 1000);
            
            // Inicializar portal
            init();
        });

        // ===== FUNCIONES DE ZOOM PARA ACCESIBILIDAD =====
        const ZOOM_MIN = 50;  // 50%
        const ZOOM_MAX = 200; // 200%
        const ZOOM_STEP = 10; // 10% por paso
        const ZOOM_DEFAULT = 100; // 100% (zoom normal)
        const ZOOM_STORAGE_KEY = 'negociolisto_portal_zoom';

        // Obtener zoom actual desde localStorage o usar el predeterminado
        function getCurrentZoom() {
            const saved = localStorage.getItem(ZOOM_STORAGE_KEY);
            return saved ? parseInt(saved, 10) : ZOOM_DEFAULT;
        }

        // Aplicar zoom a toda la p치gina
        function applyZoom(zoomLevel) {
            // Limitar entre m칤nimo y m치ximo
            zoomLevel = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, zoomLevel));
            
            // Usar zoom de CSS (compatible con todos los navegadores modernos)
            // Es m치s simple y mantiene el layout correcto
            document.body.style.zoom = `${zoomLevel}%`;
            
            // Marcar el html para posibles ajustes de estilo
            if (zoomLevel !== ZOOM_DEFAULT) {
                document.documentElement.setAttribute('data-zoom', zoomLevel.toString());
            } else {
                document.documentElement.removeAttribute('data-zoom');
            }
            
            // Guardar en localStorage
            localStorage.setItem(ZOOM_STORAGE_KEY, zoomLevel.toString());
            
            // Actualizar UI
            updateZoomDisplay(zoomLevel);
            updateZoomButtons(zoomLevel);
            
            logDebug(`游댌 Zoom ajustado a: ${zoomLevel}%`, 'info');
        }

        // Actualizar el display del nivel de zoom
        function updateZoomDisplay(zoomLevel) {
            const display = document.getElementById('zoom-level-display');
            if (display) {
                display.textContent = `${zoomLevel}%`;
            }
        }

        // Actualizar estado de los botones (habilitar/deshabilitar seg칰n l칤mites)
        function updateZoomButtons(zoomLevel) {
            const decreaseBtn = document.getElementById('zoom-decrease-btn');
            const increaseBtn = document.getElementById('zoom-increase-btn');
            
            if (decreaseBtn) {
                decreaseBtn.disabled = zoomLevel <= ZOOM_MIN;
            }
            
            if (increaseBtn) {
                increaseBtn.disabled = zoomLevel >= ZOOM_MAX;
            }
        }

        // Aumentar zoom
        function increaseZoom() {
            const current = getCurrentZoom();
            const newZoom = current + ZOOM_STEP;
            applyZoom(newZoom);
        }

        // Reducir zoom
        function decreaseZoom() {
            const current = getCurrentZoom();
            const newZoom = current - ZOOM_STEP;
            applyZoom(newZoom);
        }

        // Restablecer zoom a 100%
        function resetZoom() {
            applyZoom(ZOOM_DEFAULT);
        }

        // Inicializar zoom al cargar la p치gina
        function initZoom() {
            const savedZoom = getCurrentZoom();
            if (savedZoom !== ZOOM_DEFAULT) {
                // Aplicar zoom guardado despu칠s de un peque침o delay para asegurar que el DOM est치 listo
                setTimeout(() => {
                    applyZoom(savedZoom);
                }, 100);
            } else {
                // Solo actualizar el display si es el zoom predeterminado
                updateZoomDisplay(ZOOM_DEFAULT);
                updateZoomButtons(ZOOM_DEFAULT);
            }
            
            // Soporte para atajos de teclado (Ctrl/Cmd + +, Ctrl/Cmd + -, Ctrl/Cmd + 0)
            document.addEventListener('keydown', function(e) {
                // Ctrl + Plus o Ctrl + Equal (aumentar zoom)
                if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                    e.preventDefault();
                    increaseZoom();
                }
                // Ctrl + Minus (reducir zoom)
                else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                    e.preventDefault();
                    decreaseZoom();
                }
                // Ctrl + 0 (restablecer zoom)
                else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                    e.preventDefault();
                    resetZoom();
                }
            });
            
            logDebug('游댌 Sistema de zoom para accesibilidad inicializado', 'info');
        }
        
        // Tambi칠n actualizar consola cuando la p치gina est칠 completamente cargada
        window.addEventListener('load', function() {
            updateDebugConsole();
            // Inicializar zoom despu칠s de que la p치gina est칠 completamente cargada
            initZoom();
        });
    </script>
</body>
</html>

